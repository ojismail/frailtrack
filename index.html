<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>FrailTrack — Sit-to-Stand Assessment</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 18px;
            line-height: 1.5;
            color: #1a1a1a;
            background: #f8f9fa;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #0d6efd;
        }

        .subtitle {
            font-size: 16px;
            color: #555;
            margin-bottom: 24px;
        }

        .container {
            width: 100%;
            max-width: 420px;
        }

        /* --- Screens --- */
        .screen {
            display: none;
            width: 100%;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .screen.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 1;
        }

        /* --- Pre-Test Screen --- */
        .instructions {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            font-size: 16px;
            color: #333;
            line-height: 1.6;
        }

        .btn {
            width: 100%;
            padding: 18px 24px;
            font-size: 20px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            margin-bottom: 12px;
            transition: transform 0.1s, opacity 0.2s;
        }
        .btn:active {
            transform: scale(0.97);
        }

        .btn-primary {
            background: #0d6efd;
            color: #fff;
        }
        .btn-primary:hover {
            background: #0b5ed7;
        }

        .btn-secondary {
            background: #6c757d;
            color: #fff;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-link {
            background: none;
            color: #0d6efd;
            font-size: 16px;
            text-decoration: underline;
            padding: 12px;
        }

        /* --- Active Test Screen --- */
        .timer-display {
            font-size: 96px;
            font-weight: 800;
            color: #0d6efd;
            margin: 20px 0;
            font-variant-numeric: tabular-nums;
        }

        /* --- Live Accel Graph --- */
        .live-graph-container {
            width: 100%;
            background: #fff;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 12px;
        }
        .live-graph-container canvas {
            width: 100%;
            height: 120px;
            display: block;
        }
        .live-graph-label {
            font-size: 12px;
            color: #888;
            text-align: center;
            margin-top: 4px;
        }

        .sensor-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
        }

        .pulse-dot {
            width: 12px;
            height: 12px;
            background: #dc3545;
            border-radius: 50%;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.3); }
        }

        /* --- Results Screen --- */
        .disclaimer {
            font-size: 13px;
            color: #777;
            text-align: center;
            margin-bottom: 16px;
            line-height: 1.4;
            padding: 8px 12px;
            background: #fff8e1;
            border-radius: 8px;
            border: 1px solid #ffe082;
            width: 100%;
        }

        .results-header {
            text-align: center;
            margin-bottom: 16px;
            width: 100%;
        }
        .results-header h2 {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 4px;
        }
        .results-header .date {
            font-size: 14px;
            color: #888;
        }

        /* Tier 1: Rep Count */
        .tier-rep {
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 16px;
            width: 100%;
        }
        .tier-rep .big-number {
            font-size: 72px;
            font-weight: 800;
            color: #0d6efd;
            line-height: 1;
        }
        .tier-rep .label {
            font-size: 16px;
            color: #555;
            margin-top: 4px;
        }
        .tier-rep .norm-range {
            font-size: 14px;
            color: #888;
            margin-top: 8px;
        }

        /* Tier 2: Power */
        .tier-power {
            background: #fff;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 16px;
            width: 100%;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .tier-power .power-value {
            font-size: 36px;
            font-weight: 700;
            min-width: 110px;
        }
        .tier-power .power-info {
            flex: 1;
        }
        .tier-power .power-label {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        .tier-power .power-note {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }

        /* Tier 3: Quality Cards */
        .quality-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            width: 100%;
            margin-bottom: 20px;
        }

        .quality-card {
            background: #fff;
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-top: 4px solid #ccc;
        }
        .quality-card.status-green { border-top-color: #4CAF50; }
        .quality-card.status-yellow { border-top-color: #FF9800; }
        .quality-card.status-red { border-top-color: #F44336; }

        .quality-card .card-title {
            font-size: 14px;
            font-weight: 700;
            color: #333;
            margin-bottom: 4px;
        }
        .quality-card .card-dimension {
            font-size: 11px;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .quality-card .card-status {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 6px;
        }
        .quality-card .card-detail {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }
        .quality-card .mini-chart {
            margin: 8px 0;
            width: 100%;
            overflow: visible;
        }

        .status-msg {
            font-size: 14px;
            color: #888;
            margin-top: 16px;
            text-align: center;
        }

        /* Color helpers */
        .text-green { color: #4CAF50; }
        .text-yellow { color: #FF9800; }
        .text-red { color: #F44336; }

        /* --- Setup Screen --- */
        .setup-card {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 24px;
            width: 100%;
        }
        .setup-card label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #555;
            margin-bottom: 4px;
            margin-top: 16px;
        }
        .setup-card label:first-child { margin-top: 0; }
        .setup-card input,
        .setup-card select {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .unit-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .unit-toggle button {
            flex: 1;
            padding: 8px;
            font-size: 14px;
            border: 2px solid #0d6efd;
            border-radius: 8px;
            background: #fff;
            color: #0d6efd;
            cursor: pointer;
        }
        .unit-toggle button.active {
            background: #0d6efd;
            color: #fff;
        }
        .ft-in-row { display: flex; gap: 8px; }
        .ft-in-row input { flex: 1; }
        .optional-label {
            font-size: 12px;
            color: #999;
            font-weight: 400;
        }

        /* --- Dashboard Screen --- */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 16px;
        }
        .dashboard-header h2 { font-size: 22px; font-weight: 700; }
        .metric-tabs {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 16px;
            width: 100%;
        }
        .metric-tabs button {
            flex: 1;
            min-width: 0;
            padding: 8px 4px;
            font-size: 12px;
            font-weight: 600;
            border: 2px solid #0d6efd;
            border-radius: 8px;
            background: #fff;
            color: #0d6efd;
            cursor: pointer;
            white-space: nowrap;
        }
        .metric-tabs button.active { background: #0d6efd; color: #fff; }
        .chart-container {
            background: #fff;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 16px;
            width: 100%;
            text-align: center;
        }
        .chart-container .chart-msg { font-size: 14px; color: #888; padding: 20px 0; }
        .trend-alerts { width: 100%; margin-bottom: 16px; }
        .trend-alert {
            background: #fff8e1;
            border: 1px solid #ffe082;
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
            color: #6d4c00;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        .session-list { width: 100%; }
        .session-list h3 { font-size: 16px; font-weight: 600; margin-bottom: 8px; color: #333; }
        .session-item {
            background: #fff;
            border-radius: 10px;
            padding: 14px 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .session-item:active { background: #f0f0f0; }
        .session-item .session-info { flex: 1; }
        .session-item .session-date { font-size: 14px; font-weight: 600; color: #333; }
        .session-item .session-stats { font-size: 13px; color: #666; margin-top: 2px; }
        .session-item .session-flags { font-size: 12px; color: #FF9800; margin-top: 2px; }
        .session-item .session-delete {
            padding: 6px 10px;
            font-size: 12px;
            color: #dc3545;
            background: none;
            border: 1px solid #dc3545;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 12px;
            flex-shrink: 0;
        }
        .session-item .session-delete:active { background: #dc3545; color: #fff; }
        .btn-back-nav {
            background: none;
            border: none;
            color: #0d6efd;
            font-size: 16px;
            cursor: pointer;
            padding: 4px 0;
        }
        .empty-dashboard {
            text-align: center;
            padding: 40px 20px;
            color: #888;
            font-size: 16px;
        }

        /* --- Phase 7: Loading Overlay --- */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(248, 249, 250, 0.92);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .loading-overlay p {
            font-size: 18px;
            color: #555;
            margin-top: 16px;
            font-weight: 600;
        }
        .spinner {
            width: 48px;
            height: 48px;
            border: 5px solid #e0e0e0;
            border-top: 5px solid #0d6efd;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* (demo badge and demo note removed) */

        /* --- Phase 7: Few-Reps Warning --- */
        .few-reps-note {
            background: #fff8e1;
            border: 1px solid #ffe082;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 14px;
            color: #6d4c00;
            line-height: 1.4;
            width: 100%;
            margin-bottom: 16px;
            text-align: center;
        }

        /* (rep pulse removed) */

        /* --- Phase 7: Educational Info Box --- */
        .edu-info {
            background: #e8f4fd;
            border-radius: 10px;
            padding: 14px 16px;
            font-size: 14px;
            color: #1a5276;
            line-height: 1.5;
            margin-bottom: 16px;
            width: 100%;
            text-align: left;
        }

        /* --- Phase 7: Dashboard Educational Note --- */
        .dashboard-edu {
            font-size: 13px;
            color: #777;
            text-align: center;
            margin-bottom: 16px;
            padding: 8px 12px;
            background: #f0f7ff;
            border-radius: 8px;
            width: 100%;
            line-height: 1.4;
        }

        /* (demo tag removed) */

        /* --- Phase 7: Logo mark --- */
        .logo-mark {
            display: inline-block;
            background: #0d6efd;
            color: #fff;
            width: 32px;
            height: 32px;
            line-height: 32px;
            text-align: center;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            margin-right: 8px;
            vertical-align: middle;
        }

        /* (debug display removed — replaced by live graph) */

        /* --- Phase 7: No-reps guidance --- */
        .no-reps-guidance {
            background: #fff3e0;
            border: 1px solid #ffcc80;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            font-size: 15px;
            color: #4e342e;
            line-height: 1.6;
            width: 100%;
            margin-bottom: 16px;
        }
        .no-reps-guidance strong {
            display: block;
            font-size: 18px;
            margin-bottom: 8px;
            color: #bf360c;
        }
    </style>
</head>
<body>

<div class="container">
    <h1><span class="logo-mark">F</span>FrailTrack</h1>
    <p class="subtitle">Sit-to-Stand Movement Assessment</p>

    <!-- Screen: Setup (first visit only) -->
    <div id="screen-setup" class="screen">
        <div style="text-align:center; margin-bottom:16px;">
            <p style="font-size:16px; color:#555;">Welcome! Let's set up your profile before your first test.</p>
        </div>
        <div class="setup-card">
            <label>Height <span style="color:#dc3545">*</span></label>
            <div class="unit-toggle" id="unit-toggle">
                <button class="active" data-unit="cm">cm</button>
                <button data-unit="ftin">ft / in</button>
            </div>
            <div id="height-cm-input">
                <input type="number" id="setup-height-cm" placeholder="e.g. 170" min="100" max="250" inputmode="numeric">
            </div>
            <div id="height-ftin-input" style="display:none;">
                <div class="ft-in-row">
                    <input type="number" id="setup-height-ft" placeholder="ft" min="3" max="7" inputmode="numeric">
                    <input type="number" id="setup-height-in" placeholder="in" min="0" max="11" inputmode="numeric">
                </div>
            </div>

            <label>Age Group <span class="optional-label">(optional)</span></label>
            <select id="setup-age">
                <option value="">-- Select --</option>
                <option value="60-64">60-64</option>
                <option value="65-69">65-69</option>
                <option value="70-74">70-74</option>
                <option value="75-79">75-79</option>
                <option value="80-84">80-84</option>
                <option value="85-89">85-89</option>
                <option value="90-94">90-94</option>
            </select>

            <label>Sex <span class="optional-label">(optional)</span></label>
            <select id="setup-sex">
                <option value="">-- Select --</option>
                <option value="female">Female</option>
                <option value="male">Male</option>
            </select>
        </div>
        <button class="btn btn-primary" id="btn-get-started">Get Started</button>
    </div>

    <!-- Screen: Pre-Test -->
    <div id="screen-pretest" class="screen">
        <div class="edu-info">
            The 30-second chair stand test measures lower body strength and endurance. This app uses motion sensors to analyze your movement quality beyond just counting reps.
        </div>
        <div class="instructions">
            <strong>Instructions:</strong><br>
            Place your phone in your waistband at your front hip. Sit in a standard chair with arms crossed over your chest. When ready, tap Start.
        </div>
        <button class="btn btn-primary" id="btn-start">Start Test</button>
        <button class="btn btn-link" id="btn-dashboard">View Dashboard</button>
        <button class="btn btn-link" id="btn-settings">Settings</button>
    </div>

    <!-- Screen: Active Test -->
    <div id="screen-test" class="screen">
        <div class="sensor-indicator">
            <div class="pulse-dot"></div>
            <span id="sensor-status">Sensors active</span>
        </div>
        <div class="timer-display" id="timer">30</div>
        <div class="live-graph-container">
            <canvas id="live-graph" width="380" height="120"></canvas>
            <div class="live-graph-label">accel_mag (g) — last 5 seconds</div>
        </div>
    </div>

    <!-- Screen: Results -->
    <div id="screen-results" class="screen">
        <button class="btn-back-nav" id="btn-results-back" style="display:none; align-self:flex-start; margin-bottom:8px;">&#8592; Back to Dashboard</button>
        <div class="disclaimer">
            Screening tool — not a medical diagnosis. Share results with your healthcare provider.
        </div>

        <div id="few-reps-note" class="few-reps-note" style="display:none;">
            Fewer than 3 reps detected. CV and fatigue indicators require more reps to be meaningful.
        </div>

        <div class="results-header">
            <h2>Your Results</h2>
            <div class="date" id="result-date"></div>
        </div>

        <!-- Tier 1: Rep Count -->
        <div class="tier-rep">
            <div class="big-number" id="result-reps">—</div>
            <div class="label">Repetitions in 30 seconds</div>
            <div class="norm-range" id="result-norm"></div>
        </div>

        <!-- Tier 2: Power -->
        <div class="tier-power">
            <div class="power-value" id="result-power">—</div>
            <div class="power-info">
                <div class="power-label">Relative Muscle Power</div>
                <div class="power-status" id="result-power-status"></div>
                <div class="power-note">Based on Alcázar et al. (2021) equation</div>
            </div>
        </div>

        <!-- Tier 3: Quality Cards -->
        <div class="quality-grid">
            <!-- Card 1: Push-off Force -->
            <div class="quality-card" id="card-accel">
                <div class="card-title">Push-off Force</div>
                <div class="card-dimension">Weakness indicator</div>
                <div class="mini-chart" id="chart-accel"></div>
                <div class="card-status" id="status-accel"></div>
                <div class="card-detail" id="detail-accel"></div>
            </div>

            <!-- Card 2: Rotational Speed -->
            <div class="quality-card" id="card-gyro">
                <div class="card-title">Rotational Speed</div>
                <div class="card-dimension">Slowness indicator</div>
                <div class="mini-chart" id="chart-gyro"></div>
                <div class="card-status" id="status-gyro"></div>
                <div class="card-detail" id="detail-gyro"></div>
            </div>

            <!-- Card 3: Consistency -->
            <div class="quality-card" id="card-cv">
                <div class="card-title">Consistency</div>
                <div class="card-dimension">Exhaustion indicator</div>
                <div class="card-status" id="status-cv"></div>
                <div class="card-detail" id="detail-cv"></div>
            </div>

            <!-- Card 4: Fatigue Trend -->
            <div class="quality-card" id="card-fatigue">
                <div class="card-title">Fatigue Trend</div>
                <div class="card-dimension">Exhaustion indicator</div>
                <div class="mini-chart" id="chart-fatigue"></div>
                <div class="card-status" id="status-fatigue"></div>
                <div class="card-detail" id="detail-fatigue"></div>
            </div>
        </div>

        <button class="btn btn-primary" id="btn-save">Save &amp; View Dashboard</button>
        <button class="btn btn-secondary" id="btn-newtest">New Test</button>
    </div>

    <!-- Screen: Dashboard -->
    <div id="screen-dashboard" class="screen">
        <div class="dashboard-header">
            <button class="btn-back-nav" id="btn-dash-back">&#8592; Back</button>
            <h2>Dashboard</h2>
            <div style="width:60px;"></div>
        </div>

        <div class="dashboard-edu">
            Track changes over time. Discuss significant changes with your healthcare provider.
        </div>

        <div class="metric-tabs" id="metric-tabs">
            <button class="active" data-metric="rep_count">Reps</button>
            <button data-metric="power_wkg">Power</button>
            <button data-metric="mean_peak_accel">Accel</button>
            <button data-metric="cv_accel">CV</button>
            <button data-metric="fatigue_slope">Fatigue</button>
        </div>
        <div class="chart-container" id="trend-chart-container">
            <div class="chart-msg">No sessions yet. Complete a test to see trends.</div>
        </div>

        <div class="trend-alerts" id="trend-alerts"></div>

        <div class="session-list">
            <h3>Session History</h3>
            <div id="session-list-items"></div>
        </div>
    </div>

    <!-- Phase 7: Loading overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display:none;">
        <div class="spinner"></div>
        <p>Analyzing...</p>
    </div>
</div>

<script>

// =============================================================
// PEAK DETECTION CONSTANTS (easy to tune)
// =============================================================
const PEAK_THRESHOLD = 1.15;   // g's — accel_mag must exceed this
const MIN_PEAK_GAP = 35;       // samples (0.7s at 50Hz)
const LOCAL_MAX_RANGE = 15;    // samples — local max checked ±15
const SMOOTH_WINDOW = 15;      // moving average window (0.3s at 50Hz)
const GRAPH_SAMPLES = 250;     // 5 seconds at 50Hz
const GRAPH_Y_MAX = 3.0;       // g's — Y axis max

// =============================================================
// AUDIO — create AudioContext on first user tap anywhere
// =============================================================
let audioCtx = null;
document.addEventListener('click', () => {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === 'suspended') {
        audioCtx.resume();
    }
}, { once: false });

function playBeep(frequency = 800, duration = 200) {
    if (!audioCtx) return;
    try {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.frequency.value = frequency;
        gainNode.gain.value = 0.3;
        oscillator.start();
        oscillator.stop(audioCtx.currentTime + duration / 1000);
    } catch (e) {
        console.warn('Audio beep failed:', e);
    }
}

// =============================================================
// APP STATE
// =============================================================
let sensorBuffer = [];
let isRunning = false;
let timerInterval = null;
let sensorListener = null;
let timeRemaining = 30;
let graphInterval = null;

// =============================================================
// DOM REFS
// =============================================================
const screenPretest = document.getElementById('screen-pretest');
const screenTest = document.getElementById('screen-test');
const screenResults = document.getElementById('screen-results');
const timerDisplay = document.getElementById('timer');
const sensorStatus = document.getElementById('sensor-status');

const btnStart = document.getElementById('btn-start');
const btnDashboard = document.getElementById('btn-dashboard');
const btnSave = document.getElementById('btn-save');
const btnNewTest = document.getElementById('btn-newtest');

// Phase 6 DOM refs
const screenSetup = document.getElementById('screen-setup');
const screenDashboard = document.getElementById('screen-dashboard');
const btnGetStarted = document.getElementById('btn-get-started');
const btnSettings = document.getElementById('btn-settings');
const btnDashBack = document.getElementById('btn-dash-back');
const btnResultsBack = document.getElementById('btn-results-back');

// Live graph
const liveCanvas = document.getElementById('live-graph');
const liveCtx = liveCanvas.getContext('2d');

// Last session data (for saving later)
let lastSessionData = null;

// =============================================================
// NORMATIVE REFERENCE TABLE (Jones et al., 1999)
// =============================================================
const NORMATIVE_TABLE = {
    '60-64': { female: [12, 17], male: [14, 19] },
    '65-69': { female: [11, 16], male: [12, 18] },
    '70-74': { female: [10, 15], male: [12, 17] },
    '75-79': { female: [10, 15], male: [11, 17] },
    '80-84': { female: [9, 14],  male: [10, 15] },
    '85-89': { female: [8, 13],  male: [8, 14] },
    '90-94': { female: [4, 11],  male: [7, 12] }
};

// =============================================================
// PERSISTENCE (Phase 6)
// =============================================================
function getProfile() {
    try {
        const raw = localStorage.getItem('frailtrack_profile');
        return raw ? JSON.parse(raw) : null;
    } catch (e) { return null; }
}

function saveProfile(profile) {
    localStorage.setItem('frailtrack_profile', JSON.stringify(profile));
}

function getSessions() {
    try {
        const raw = localStorage.getItem('frailtrack_sessions');
        return raw ? JSON.parse(raw) : [];
    } catch (e) { return []; }
}

function saveSessionToStorage(sessionData) {
    const sessions = getSessions();
    const now = new Date();
    const entry = {
        id: 'session_' + Date.now(),
        date: now.toISOString().slice(0, 19),
        rep_count: sessionData.repCount,
        power_wkg: parseFloat(sessionData.power.toFixed(2)),
        mean_time_per_rep: parseFloat(sessionData.meanTime.toFixed(2)),
        per_rep: sessionData.perRep.map((r, i) => ({
            rep: i + 1,
            peak_accel: parseFloat(r.peak_accel.toFixed(2)),
            peak_gyro: parseFloat(r.peak_gyro.toFixed(2)),
            duration: parseFloat(r.duration.toFixed(2))
        })),
        cv_accel: parseFloat(sessionData.cvAccel.toFixed(4)),
        fatigue_slope: parseFloat(sessionData.fatigueSlope.toFixed(4)),
        flags: { ...sessionData.flags }
    };
    sessions.push(entry);
    try {
        localStorage.setItem('frailtrack_sessions', JSON.stringify(sessions));
    } catch (e) {
        if (e.name === 'QuotaExceededError' || e.code === 22) {
            alert('Storage is full. Delete old sessions from the Dashboard to save new ones.');
        } else {
            console.error('Error saving session:', e);
            alert('Could not save session. Please try again.');
        }
    }
    return entry;
}

function deleteSession(sessionId) {
    let sessions = getSessions();
    sessions = sessions.filter(s => s.id !== sessionId);
    localStorage.setItem('frailtrack_sessions', JSON.stringify(sessions));
}

function getNormativeRange(ageGroup, sex) {
    if (!ageGroup || !sex) return null;
    const group = NORMATIVE_TABLE[ageGroup];
    return group ? (group[sex] || null) : null;
}

// =============================================================
// SCREEN MANAGEMENT
// =============================================================
function showScreen(screen) {
    const current = document.querySelector('.screen.active');
    if (current && current !== screen) {
        current.style.opacity = '0';
        setTimeout(() => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screen.classList.add('active');
            screen.offsetHeight;
            screen.style.opacity = '1';
        }, 200);
    } else {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        screen.classList.add('active');
        screen.style.opacity = '1';
    }
}

// =============================================================
// TIMER
// =============================================================
function startTimer() {
    timeRemaining = 30;
    timerDisplay.textContent = timeRemaining;
    timerInterval = setInterval(() => {
        timeRemaining--;
        timerDisplay.textContent = Math.max(0, timeRemaining);
        if (timeRemaining <= 0) {
            stopTest();
        }
    }, 1000);
}

// =============================================================
// LIVE ACCELERATION GRAPH (Canvas)
// =============================================================
function drawLiveGraph() {
    const canvas = liveCanvas;
    const ctx = liveCtx;

    // Size canvas to actual CSS pixel dimensions
    const rect = canvas.parentElement.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    const w = rect.width - 24; // account for padding
    const h = 120;
    canvas.width = w * dpr;
    canvas.height = h * dpr;
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

    // Clear
    ctx.clearRect(0, 0, w, h);

    // Get last GRAPH_SAMPLES samples of accel_mag
    const start = Math.max(0, sensorBuffer.length - GRAPH_SAMPLES);
    const samples = [];
    for (let i = start; i < sensorBuffer.length; i++) {
        const s = sensorBuffer[i];
        samples.push(Math.sqrt(s.ax * s.ax + s.ay * s.ay + s.az * s.az));
    }

    const padLeft = 30;
    const padRight = 5;
    const padTop = 5;
    const padBottom = 15;
    const plotW = w - padLeft - padRight;
    const plotH = h - padTop - padBottom;

    // Y axis labels
    ctx.fillStyle = '#999';
    ctx.font = '10px -apple-system, sans-serif';
    ctx.textAlign = 'right';
    ctx.fillText(GRAPH_Y_MAX.toFixed(1), padLeft - 4, padTop + 8);
    ctx.fillText('0', padLeft - 4, padTop + plotH);
    const midY = GRAPH_Y_MAX / 2;
    ctx.fillText(midY.toFixed(1), padLeft - 4, padTop + plotH / 2 + 4);

    // Threshold dashed line
    const threshY = padTop + plotH - (PEAK_THRESHOLD / GRAPH_Y_MAX) * plotH;
    ctx.beginPath();
    ctx.setLineDash([4, 3]);
    ctx.strokeStyle = '#FF9800';
    ctx.lineWidth = 1;
    ctx.moveTo(padLeft, threshY);
    ctx.lineTo(padLeft + plotW, threshY);
    ctx.stroke();
    ctx.setLineDash([]);

    // Threshold label
    ctx.fillStyle = '#FF9800';
    ctx.textAlign = 'left';
    ctx.font = '9px -apple-system, sans-serif';
    ctx.fillText(PEAK_THRESHOLD + 'g', padLeft + plotW - 28, threshY - 3);

    // Draw data
    if (samples.length < 2) return;

    ctx.beginPath();
    ctx.strokeStyle = '#0d6efd';
    ctx.lineWidth = 1.5;

    const xStep = plotW / GRAPH_SAMPLES;
    const xOffset = (GRAPH_SAMPLES - samples.length) * xStep; // right-align data

    for (let i = 0; i < samples.length; i++) {
        const x = padLeft + xOffset + i * xStep;
        const val = Math.min(samples[i], GRAPH_Y_MAX);
        const y = padTop + plotH - (val / GRAPH_Y_MAX) * plotH;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    }
    ctx.stroke();

    // Fill area above threshold in light orange
    ctx.beginPath();
    ctx.fillStyle = 'rgba(255, 152, 0, 0.1)';
    let inAbove = false;
    for (let i = 0; i < samples.length; i++) {
        const x = padLeft + xOffset + i * xStep;
        const val = Math.min(samples[i], GRAPH_Y_MAX);
        const y = padTop + plotH - (val / GRAPH_Y_MAX) * plotH;
        if (val >= PEAK_THRESHOLD) {
            if (!inAbove) {
                ctx.moveTo(x, threshY);
                inAbove = true;
            }
            ctx.lineTo(x, y);
        } else {
            if (inAbove) {
                ctx.lineTo(x, threshY);
                ctx.closePath();
                ctx.fill();
                ctx.beginPath();
                inAbove = false;
            }
        }
    }
    if (inAbove) {
        const lastX = padLeft + xOffset + (samples.length - 1) * xStep;
        ctx.lineTo(lastX, threshY);
        ctx.closePath();
        ctx.fill();
    }

    // Current value text
    if (samples.length > 0) {
        const current = samples[samples.length - 1];
        ctx.fillStyle = current >= PEAK_THRESHOLD ? '#FF9800' : '#0d6efd';
        ctx.font = 'bold 14px -apple-system, sans-serif';
        ctx.textAlign = 'right';
        ctx.fillText(current.toFixed(2) + 'g', padLeft + plotW, padTop + 14);
    }
}

function startGraphUpdates() {
    // Update graph every 100ms
    graphInterval = setInterval(drawLiveGraph, 100);
}

function stopGraphUpdates() {
    if (graphInterval) { clearInterval(graphInterval); graphInterval = null; }
}

// =============================================================
// SMOOTHED ACCEL_MAG COMPUTATION
// =============================================================
function computeSmoothedAccelMag(buffer) {
    const raw = buffer.map(s => Math.sqrt(s.ax * s.ax + s.ay * s.ay + s.az * s.az));
    const smoothed = new Array(raw.length);
    const half = Math.floor(SMOOTH_WINDOW / 2);
    for (let i = 0; i < raw.length; i++) {
        let sum = 0, count = 0;
        for (let j = Math.max(0, i - half); j <= Math.min(raw.length - 1, i + half); j++) {
            sum += raw[j];
            count++;
        }
        smoothed[i] = sum / count;
    }
    return smoothed;
}

// =============================================================
// PEAK DETECTION (on full buffer, post-test)
// =============================================================
function detectPeaks(buffer) {
    if (buffer.length < SMOOTH_WINDOW) return [];

    const smoothed = computeSmoothedAccelMag(buffer);
    const peaks = [];
    let lastPeakIdx = -MIN_PEAK_GAP;

    for (let i = LOCAL_MAX_RANGE; i < smoothed.length - LOCAL_MAX_RANGE; i++) {
        if (smoothed[i] < PEAK_THRESHOLD) continue;
        if (i - lastPeakIdx < MIN_PEAK_GAP) continue;

        let isMax = true;
        for (let j = i - LOCAL_MAX_RANGE; j <= i + LOCAL_MAX_RANGE; j++) {
            if (j !== i && smoothed[j] > smoothed[i]) {
                isMax = false;
                break;
            }
        }
        if (!isMax) continue;

        peaks.push({ sampleIndex: i, value: smoothed[i] });
        lastPeakIdx = i;
    }

    return peaks;
}

function peaksToEvents(peaks) {
    return peaks.map((p, idx) => ({
        rep: idx + 1,
        start_sample: p.sampleIndex - LOCAL_MAX_RANGE,
        end_sample: p.sampleIndex + LOCAL_MAX_RANGE,
        peak_sample: p.sampleIndex,
        start_time: (p.sampleIndex - LOCAL_MAX_RANGE) / 50,
        end_time: (p.sampleIndex + LOCAL_MAX_RANGE) / 50
    }));
}

// =============================================================
// REAL SENSOR MODE
// =============================================================
async function startRealSensors() {
    isRunning = true;
    sensorBuffer = [];

    // Request permission (iOS)
    if (typeof DeviceMotionEvent !== 'undefined' &&
        typeof DeviceMotionEvent.requestPermission === 'function') {
        try {
            const permission = await DeviceMotionEvent.requestPermission();
            if (permission !== 'granted') {
                alert('Sensor permission denied. Please allow motion access.');
                isRunning = false;
                return;
            }
        } catch (e) {
            alert('Could not request sensor permission: ' + e.message);
            isRunning = false;
            return;
        }
    }

    sensorStatus.textContent = 'Sensors active';
    showScreen(screenTest);
    playBeep(800, 300);
    startTimer();
    startGraphUpdates();

    let nullDataCount = 0;
    let receivedData = false;

    sensorListener = function(event) {
        if (!isRunning) return;

        const accel = event.accelerationIncludingGravity;
        const rot = event.rotationRate;

        if (!accel || accel.x === null || !rot || rot.alpha === null) {
            nullDataCount++;
            if (nullDataCount > 10 && !receivedData) {
                sensorStatus.textContent = 'No sensor data received';
            }
            return;
        }

        receivedData = true;
        sensorBuffer.push({
            ax: accel.x / 9.81,       // m/s² → g's
            ay: accel.y / 9.81,
            az: accel.z / 9.81,
            gx: rot.alpha * Math.PI / 180,  // deg/s → rad/s
            gy: rot.beta * Math.PI / 180,
            gz: rot.gamma * Math.PI / 180,
            timestamp: event.timeStamp || performance.now()
        });
    };

    window.addEventListener('devicemotion', sensorListener);
}

// =============================================================
// RESAMPLE TO 50Hz
// =============================================================
function resampleTo50Hz(buffer) {
    if (buffer.length < 2) return { resampled: buffer, actualRate: 0 };

    const startTime = buffer[0].timestamp;
    const endTime = buffer[buffer.length - 1].timestamp;
    const durationMs = endTime - startTime;
    const actualRate = (buffer.length - 1) / (durationMs / 1000);

    console.log(`Actual sample rate: ${actualRate.toFixed(1)} Hz`);

    if (actualRate >= 45 && actualRate <= 55) {
        return { resampled: buffer, actualRate };
    }

    const targetInterval = 20;
    const targetCount = Math.round(durationMs / targetInterval) + 1;
    const resampled = [];
    let bufIdx = 0;

    for (let i = 0; i < targetCount; i++) {
        const targetTime = startTime + i * targetInterval;
        while (bufIdx < buffer.length - 2 && buffer[bufIdx + 1].timestamp < targetTime) bufIdx++;

        const s0 = buffer[bufIdx];
        const s1 = buffer[Math.min(bufIdx + 1, buffer.length - 1)];
        const dt = s1.timestamp - s0.timestamp;
        const t = dt > 0 ? (targetTime - s0.timestamp) / dt : 0;

        resampled.push({
            ax: s0.ax + t * (s1.ax - s0.ax),
            ay: s0.ay + t * (s1.ay - s0.ay),
            az: s0.az + t * (s1.az - s0.az),
            gx: s0.gx + t * (s1.gx - s0.gx),
            gy: s0.gy + t * (s1.gy - s0.gy),
            gz: s0.gz + t * (s1.gz - s0.gz),
            timestamp: targetTime
        });
    }

    console.log(`Resampled from ${buffer.length} to ${resampled.length} samples (50Hz).`);
    return { resampled, actualRate };
}

// =============================================================
// GRAVITY REMOVAL
// =============================================================
function removeGravity(buffer) {
    const alpha = 0.9;
    const filtered = [];
    filtered.push({
        ax: 0, ay: 0, az: 0,
        gx: buffer[0].gx, gy: buffer[0].gy, gz: buffer[0].gz
    });
    for (let i = 1; i < buffer.length; i++) {
        filtered.push({
            ax: alpha * (filtered[i - 1].ax + buffer[i].ax - buffer[i - 1].ax),
            ay: alpha * (filtered[i - 1].ay + buffer[i].ay - buffer[i - 1].ay),
            az: alpha * (filtered[i - 1].az + buffer[i].az - buffer[i - 1].az),
            gx: buffer[i].gx, gy: buffer[i].gy, gz: buffer[i].gz
        });
    }
    return filtered;
}

// =============================================================
// PER-REP FEATURE EXTRACTION
// =============================================================
function extractRepFeatures(filteredBuffer, event) {
    const start = Math.max(0, event.start_sample);
    const end = Math.min(filteredBuffer.length, event.end_sample);
    const samples = filteredBuffer.slice(start, end);
    if (samples.length === 0) return null;

    let peakAccel = 0;
    for (let i = 0; i < samples.length; i++) {
        const s = samples[i];
        const mag = Math.sqrt(s.ax * s.ax + s.ay * s.ay + s.az * s.az) * 9.81;
        if (mag > peakAccel) peakAccel = mag;
    }

    const duration = (end - start) / 50;

    let peakGyro = 0;
    for (let i = 0; i < samples.length; i++) {
        const s = samples[i];
        const mag = Math.sqrt(s.gx * s.gx + s.gy * s.gy + s.gz * s.gz);
        if (mag > peakGyro) peakGyro = mag;
    }

    return { peak_accel: peakAccel, duration, peak_gyro: peakGyro };
}

// =============================================================
// SESSION-LEVEL INDICATORS
// =============================================================
function computeSessionIndicators(repFeatures, heightM) {
    const n = repFeatures.length;
    if (n === 0) return null;

    const repCount = n;
    const meanTime = repFeatures.reduce((s, r) => s + r.duration, 0) / n;
    const power = (0.9 * 9.81 * (heightM * 0.5 - 0.46)) / (meanTime * 0.5);

    const accels = repFeatures.map(r => r.peak_accel);
    const meanAccel = accels.reduce((a, b) => a + b, 0) / n;
    const stdAccel = Math.sqrt(accels.reduce((s, a) => s + (a - meanAccel) ** 2, 0) / n);
    const cvAccel = meanAccel > 0 ? stdAccel / meanAccel : 0;

    let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
    for (let i = 0; i < n; i++) {
        const x = i + 1, y = accels[i];
        sumX += x; sumY += y; sumXY += x * y; sumX2 += x * x;
    }
    const denom = n * sumX2 - sumX * sumX;
    const fatigueSlope = denom !== 0 ? (n * sumXY - sumX * sumY) / denom : 0;

    const flags = {
        weakness_accel: meanAccel < 2.7 ? 'low' : meanAccel > 8.5 ? 'high' : 'intermediate',
        weakness_power: power < 2.0 ? 'below_range' : 'within_range',
        exhaustion_cv: cvAccel < 0.15 ? 'stable' : cvAccel < 0.30 ? 'moderate' : 'high',
        exhaustion_fatigue: fatigueSlope > -0.05 ? 'stable' : fatigueSlope > -0.15 ? 'mild_decline' : 'significant_decline'
    };

    return { repCount, meanTime, power, cvAccel, fatigueSlope, flags, perRep: repFeatures };
}

// =============================================================
// FULL ANALYSIS PIPELINE
// =============================================================
function analyzeSession(buffer) {
    const profile = getProfile();
    const heightM = (profile && profile.height_m) ? profile.height_m : 1.70;

    console.log('\n=== Peak Detection & Quality Assessment ===');

    const peaks = detectPeaks(buffer);
    const events = peaksToEvents(peaks);
    console.log(`Detected ${events.length} rep(s) via peak detection`);
    events.forEach(e => {
        console.log(`  Rep ${e.rep}: peak at sample ${e.peak_sample} (${(e.peak_sample/50).toFixed(2)}s), value=${peaks[e.rep-1].value.toFixed(3)}g`);
    });

    if (events.length === 0) {
        console.log('No reps detected.');
        return null;
    }

    const filteredBuffer = removeGravity(buffer);

    const repFeatures = [];
    events.forEach(event => {
        const feats = extractRepFeatures(filteredBuffer, event);
        if (feats) repFeatures.push(feats);
    });

    const session = computeSessionIndicators(repFeatures, heightM);
    if (session) {
        console.log(`Rep count: ${session.repCount}, Power: ${session.power.toFixed(2)} W/kg`);
    }

    return session;
}

// =============================================================
// STOP TEST
// =============================================================
function stopTest() {
    isRunning = false;

    if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
    if (sensorListener) {
        window.removeEventListener('devicemotion', sensorListener);
        sensorListener = null;
    }
    stopGraphUpdates();

    // End beep
    playBeep(600, 500);

    // Show loading overlay
    document.getElementById('loading-overlay').style.display = 'flex';

    setTimeout(() => {
        try {
            // Resample
            const result = resampleTo50Hz(sensorBuffer);
            sensorBuffer = result.resampled;

            console.log('=== Test Complete ===');
            console.log(`Total samples: ${sensorBuffer.length}`);

            const sessionData = analyzeSession(sensorBuffer);

            lastSessionData = sessionData;
            renderResults(sessionData);
            document.getElementById('loading-overlay').style.display = 'none';
            showScreen(screenResults);
        } catch (err) {
            console.error('Error processing test data:', err);
            document.getElementById('loading-overlay').style.display = 'none';
            lastSessionData = null;
            renderResults(null);
            showScreen(screenResults);
        }
    }, 50);
}

// =============================================================
// SVG MINI CHARTS (Phase 5)
// =============================================================
function createBarChart(values, options = {}) {
    const {
        width = 140, height = 60, color = '#0d6efd',
        showTrend = false, trendSlope = 0, trendIntercept = 0
    } = options;
    if (!values || values.length === 0) return '';

    const maxVal = Math.max(...values, 0.001);
    const barWidth = Math.max(4, Math.min(20, (width - 4) / values.length - 2));
    const gap = 2;
    const totalWidth = values.length * (barWidth + gap) - gap;
    const offsetX = (width - totalWidth) / 2;

    let bars = '';
    values.forEach((v, i) => {
        const barH = Math.max(2, (v / maxVal) * (height - 8));
        const x = offsetX + i * (barWidth + gap);
        const y = height - barH - 2;
        bars += `<rect x="${x}" y="${y}" width="${barWidth}" height="${barH}" rx="2" fill="${color}" opacity="0.8"/>`;
    });

    let trendLine = '';
    if (showTrend && values.length > 1) {
        const y1 = height - 2 - ((trendIntercept + trendSlope) / maxVal) * (height - 8);
        const y2 = height - 2 - ((trendIntercept + trendSlope * values.length) / maxVal) * (height - 8);
        const x1 = offsetX + barWidth / 2;
        const x2 = offsetX + (values.length - 1) * (barWidth + gap) + barWidth / 2;
        trendLine = `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#F44336" stroke-width="2" stroke-dasharray="4,2"/>`;
    }

    return `<svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">${bars}${trendLine}</svg>`;
}

// =============================================================
// RENDER RESULTS SCREEN
// =============================================================
function renderResults(session, savedDate) {
    const dateObj = savedDate ? new Date(savedDate) : new Date();
    document.getElementById('result-date').textContent =
        dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' }) +
        ' at ' + dateObj.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

    const fewRepsNoteEl = document.getElementById('few-reps-note');
    fewRepsNoteEl.style.display = 'none';

    if (!session || session.repCount === 0) {
        document.getElementById('result-reps').textContent = '0';
        document.getElementById('result-norm').innerHTML =
            '<strong>No sit-to-stand movements detected.</strong><br>' +
            'Make sure the phone is at your waist and you are standing up fully from the chair.';
        document.getElementById('result-power').textContent = '—';
        document.getElementById('result-power-status').textContent = '';
        ['accel', 'gyro', 'cv', 'fatigue'].forEach(id => {
            document.getElementById('status-' + id).textContent = 'No data';
            document.getElementById('detail-' + id).textContent = '';
            const chart = document.getElementById('chart-' + id);
            if (chart) chart.innerHTML = '';
            document.getElementById('card-' + id).className = 'quality-card';
        });
        return;
    }

    if (session.repCount < 3) {
        fewRepsNoteEl.style.display = '';
    }

    document.getElementById('result-reps').textContent = session.repCount;
    const profileForNorm = getProfile();
    const normRange = getNormativeRange(
        profileForNorm ? profileForNorm.age_group : null,
        profileForNorm ? profileForNorm.sex : null
    );
    if (normRange) {
        const sexLabel = profileForNorm.sex === 'female' ? 'Women' : 'Men';
        document.getElementById('result-norm').textContent =
            `Typical for ${sexLabel} ages ${profileForNorm.age_group}: ${normRange[0]}–${normRange[1]} reps`;
    } else {
        document.getElementById('result-norm').textContent =
            'Set age group & sex in Settings for personalized comparison';
    }

    const powerEl = document.getElementById('result-power');
    const powerStatusEl = document.getElementById('result-power-status');
    powerEl.textContent = session.power.toFixed(2) + ' W/kg';

    if (session.flags.weakness_power === 'below_range') {
        powerEl.className = 'power-value text-yellow';
        powerStatusEl.textContent = 'Below typical range';
        powerStatusEl.className = 'power-status text-yellow';
    } else {
        powerEl.className = 'power-value text-green';
        powerStatusEl.textContent = 'Within typical range';
        powerStatusEl.className = 'power-status text-green';
    }

    const perRep = session.perRep;
    const accels = perRep.map(r => r.peak_accel);
    const meanAccel = accels.reduce((a, b) => a + b, 0) / accels.length;
    document.getElementById('chart-accel').innerHTML = createBarChart(accels, { color: statusColor(session.flags.weakness_accel) });
    document.getElementById('card-accel').className = 'quality-card status-' + statusClass(session.flags.weakness_accel);
    const accelStatusText = session.flags.weakness_accel === 'low' ? 'Low' :
        session.flags.weakness_accel === 'high' ? 'Strong' : 'Intermediate';
    document.getElementById('status-accel').textContent = accelStatusText;
    document.getElementById('status-accel').className = 'card-status ' + statusTextClass(session.flags.weakness_accel);
    document.getElementById('detail-accel').innerHTML =
        `Avg ${meanAccel.toFixed(1)} m/s&sup2; across ${accels.length} rep(s)<br><span style="color:#888;font-size:12px;">Measures how forcefully you push up from the chair</span>`;

    const gyros = perRep.map(r => r.peak_gyro);
    const meanGyro = gyros.reduce((a, b) => a + b, 0) / gyros.length;
    const gyroStatus = meanGyro > 2.0 ? 'high' : meanGyro > 1.0 ? 'intermediate' : 'low';
    document.getElementById('chart-gyro').innerHTML = createBarChart(gyros, { color: statusColor(gyroStatus) });
    document.getElementById('card-gyro').className = 'quality-card status-' + statusClass(gyroStatus);
    const gyroStatusText = gyroStatus === 'low' ? 'Low' : gyroStatus === 'high' ? 'Good' : 'Moderate';
    document.getElementById('status-gyro').textContent = gyroStatusText;
    document.getElementById('status-gyro').className = 'card-status ' + statusTextClass(gyroStatus);
    document.getElementById('detail-gyro').innerHTML =
        `Avg ${meanGyro.toFixed(2)} rad/s across ${gyros.length} rep(s)<br><span style="color:#888;font-size:12px;">Measures how quickly your body rotates during the stand</span>`;

    const cvCard = document.getElementById('card-cv');
    const cvFlag = session.flags.exhaustion_cv;
    cvCard.className = 'quality-card status-' + statusClass(cvFlag === 'stable' ? 'high' : cvFlag === 'moderate' ? 'intermediate' : 'low');
    document.getElementById('status-cv').textContent = `CV = ${session.cvAccel.toFixed(2)}`;
    document.getElementById('status-cv').className = 'card-status ' +
        (cvFlag === 'stable' ? 'text-green' : cvFlag === 'moderate' ? 'text-yellow' : 'text-red');
    const cvDetailText = cvFlag === 'stable' ? 'Your reps were consistent' :
        cvFlag === 'moderate' ? 'Some variation between reps' : 'Your performance varied significantly across reps';
    document.getElementById('detail-cv').innerHTML =
        cvDetailText + '<br><span style="color:#888;font-size:12px;">How similar your reps are to each other</span>';

    const fatigueCard = document.getElementById('card-fatigue');
    const fatFlag = session.flags.exhaustion_fatigue;
    fatigueCard.className = 'quality-card status-' + statusClass(fatFlag === 'stable' ? 'high' : fatFlag === 'mild_decline' ? 'intermediate' : 'low');
    const meanRepNum = (accels.length + 1) / 2;
    const trendIntercept = meanAccel - session.fatigueSlope * meanRepNum;
    document.getElementById('chart-fatigue').innerHTML = createBarChart(accels, {
        color: '#6c757d',
        showTrend: accels.length > 1,
        trendSlope: session.fatigueSlope,
        trendIntercept: trendIntercept
    });
    const fatStatusText = fatFlag === 'stable' ? 'Stable' :
        fatFlag === 'mild_decline' ? 'Mild decline' : 'Significant decline';
    document.getElementById('status-fatigue').textContent = fatStatusText;
    document.getElementById('status-fatigue').className = 'card-status ' +
        (fatFlag === 'stable' ? 'text-green' : fatFlag === 'mild_decline' ? 'text-yellow' : 'text-red');
    const fatDetailText = fatFlag === 'stable' ? 'Your performance was steady throughout' :
        fatFlag === 'mild_decline' ? 'Your later reps were slightly weaker' :
        'Your later reps were noticeably weaker than your first';
    document.getElementById('detail-fatigue').innerHTML =
        fatDetailText + '<br><span style="color:#888;font-size:12px;">Whether your performance changes from early to late reps</span>';
}

function statusColor(flag) {
    if (flag === 'high' || flag === 'strong') return '#4CAF50';
    if (flag === 'intermediate' || flag === 'moderate') return '#FF9800';
    return '#F44336';
}
function statusClass(flag) {
    if (flag === 'high' || flag === 'strong') return 'green';
    if (flag === 'intermediate' || flag === 'moderate') return 'yellow';
    return 'red';
}
function statusTextClass(flag) {
    if (flag === 'high' || flag === 'strong') return 'text-green';
    if (flag === 'intermediate' || flag === 'moderate') return 'text-yellow';
    return 'text-red';
}

// =============================================================
// SETUP SCREEN LOGIC
// =============================================================
function initSetup() {
    const unitToggle = document.getElementById('unit-toggle');
    const cmInput = document.getElementById('height-cm-input');
    const ftinInput = document.getElementById('height-ftin-input');

    unitToggle.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        unitToggle.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if (btn.dataset.unit === 'cm') {
            cmInput.style.display = '';
            ftinInput.style.display = 'none';
        } else {
            cmInput.style.display = 'none';
            ftinInput.style.display = '';
        }
    });

    btnGetStarted.addEventListener('click', () => {
        let heightM = 0;
        const activeUnit = unitToggle.querySelector('button.active').dataset.unit;

        if (activeUnit === 'cm') {
            const cm = parseFloat(document.getElementById('setup-height-cm').value);
            if (!cm || cm < 100 || cm > 250) {
                alert('Please enter a valid height (100-250 cm).');
                return;
            }
            heightM = cm / 100;
        } else {
            const ft = parseInt(document.getElementById('setup-height-ft').value) || 0;
            const inches = parseInt(document.getElementById('setup-height-in').value) || 0;
            const totalInches = ft * 12 + inches;
            if (totalInches < 36 || totalInches > 96) {
                alert('Please enter a valid height (3-8 feet).');
                return;
            }
            heightM = totalInches * 0.0254;
        }

        const profile = {
            height_m: parseFloat(heightM.toFixed(2)),
            age_group: document.getElementById('setup-age').value || null,
            sex: document.getElementById('setup-sex').value || null,
            setup_date: new Date().toISOString().slice(0, 10)
        };

        saveProfile(profile);
        showScreen(screenPretest);
    });
}

// =============================================================
// DASHBOARD
// =============================================================
let currentMetric = 'rep_count';

function showDashboard() {
    renderDashboard();
    showScreen(screenDashboard);
}

function renderDashboard() {
    const sessions = getSessions();
    renderTrendChart(sessions);
    renderTrendAlerts(sessions);
    renderSessionList(sessions);
}

function getMetricValue(session, metric) {
    switch (metric) {
        case 'rep_count': return session.rep_count;
        case 'power_wkg': return session.power_wkg;
        case 'mean_peak_accel':
            return session.per_rep.length > 0 ?
                session.per_rep.reduce((s, r) => s + r.peak_accel, 0) / session.per_rep.length : 0;
        case 'cv_accel': return session.cv_accel;
        case 'fatigue_slope': return session.fatigue_slope;
        default: return 0;
    }
}

function getMetricLabel(metric) {
    switch (metric) {
        case 'rep_count': return 'Reps';
        case 'power_wkg': return 'W/kg';
        case 'mean_peak_accel': return 'm/s²';
        case 'cv_accel': return 'CV';
        case 'fatigue_slope': return 'slope';
        default: return '';
    }
}

function getThresholdForMetric(metric) {
    switch (metric) {
        case 'power_wkg': return { value: 2.0, label: '2.0 W/kg', color: '#FF9800' };
        case 'mean_peak_accel': return { value: 2.7, label: '2.7 m/s²', color: '#FF9800' };
        case 'cv_accel': return { value: 0.30, label: 'CV 0.30', color: '#FF9800' };
        case 'fatigue_slope': return { value: -0.15, label: '-0.15', color: '#FF9800' };
        default: return null;
    }
}

function renderTrendChart(sessions) {
    const container = document.getElementById('trend-chart-container');
    if (sessions.length === 0) {
        container.innerHTML = '<div class="chart-msg">No sessions yet. Complete a test to see trends.</div>';
        return;
    }

    const sorted = [...sessions].sort((a, b) => new Date(a.date) - new Date(b.date));
    const values = sorted.map(s => getMetricValue(s, currentMetric));
    const labels = sorted.map(s => {
        const d = new Date(s.date);
        return (d.getMonth() + 1) + '/' + d.getDate();
    });

    const W = 360, H = 160, pad = 40;
    const plotW = W - pad * 2, plotH = H - pad * 2;

    let minVal = Math.min(...values);
    let maxVal = Math.max(...values);
    if (minVal === maxVal) { minVal -= 1; maxVal += 1; }
    const range = maxVal - minVal;

    const xStep = values.length > 1 ? plotW / (values.length - 1) : plotW / 2;
    let points = values.map((v, i) => {
        const x = pad + (values.length > 1 ? i * xStep : plotW / 2);
        const y = pad + plotH - ((v - minVal) / range) * plotH;
        return { x, y };
    });

    let svgContent = `<line x1="${pad}" y1="${pad}" x2="${pad}" y2="${pad + plotH}" stroke="#ddd" stroke-width="1"/>`;
    svgContent += `<line x1="${pad}" y1="${pad + plotH}" x2="${pad + plotW}" y2="${pad + plotH}" stroke="#ddd" stroke-width="1"/>`;

    const threshold = getThresholdForMetric(currentMetric);
    if (threshold && threshold.value >= minVal && threshold.value <= maxVal) {
        const thY = pad + plotH - ((threshold.value - minVal) / range) * plotH;
        svgContent += `<line x1="${pad}" y1="${thY}" x2="${pad + plotW}" y2="${thY}" stroke="${threshold.color}" stroke-width="1" stroke-dasharray="4,3"/>`;
        svgContent += `<text x="${pad + plotW + 2}" y="${thY + 4}" font-size="10" fill="${threshold.color}">${threshold.label}</text>`;
    }

    if (points.length > 1) {
        const pathD = points.map((p, i) => (i === 0 ? `M${p.x},${p.y}` : `L${p.x},${p.y}`)).join(' ');
        svgContent += `<path d="${pathD}" fill="none" stroke="#0d6efd" stroke-width="2"/>`;
    }

    points.forEach((p, i) => {
        svgContent += `<circle cx="${p.x}" cy="${p.y}" r="4" fill="#0d6efd"/>`;
        svgContent += `<text x="${p.x}" y="${p.y - 8}" text-anchor="middle" font-size="11" fill="#333">${typeof values[i] === 'number' ? (Number.isInteger(values[i]) ? values[i] : values[i].toFixed(2)) : values[i]}</text>`;
        svgContent += `<text x="${p.x}" y="${pad + plotH + 14}" text-anchor="middle" font-size="10" fill="#999">${labels[i]}</text>`;
    });

    svgContent += `<text x="${pad - 4}" y="${pad - 4}" text-anchor="end" font-size="10" fill="#999">${typeof maxVal === 'number' ? (Number.isInteger(maxVal) ? maxVal : maxVal.toFixed(2)) : maxVal}</text>`;
    svgContent += `<text x="${pad - 4}" y="${pad + plotH + 4}" text-anchor="end" font-size="10" fill="#999">${typeof minVal === 'number' ? (Number.isInteger(minVal) ? minVal : minVal.toFixed(2)) : minVal}</text>`;

    const label = getMetricLabel(currentMetric);
    svgContent += `<text x="${W / 2}" y="${H - 2}" text-anchor="middle" font-size="11" fill="#666">${label}</text>`;

    container.innerHTML = `<svg width="100%" viewBox="0 0 ${W} ${H}">${svgContent}</svg>`;
}

function renderTrendAlerts(sessions) {
    const container = document.getElementById('trend-alerts');
    container.innerHTML = '';
    if (sessions.length < 3) return;

    const sorted = [...sessions].sort((a, b) => new Date(a.date) - new Date(b.date));
    const last3 = sorted.slice(-3);
    const alerts = [];

    const fs = last3.map(s => s.fatigue_slope);
    if (fs[0] < fs[1] && fs[1] < fs[2]) alerts.push('Your fatigue slope has worsened over your last 3 sessions.');

    const cv = last3.map(s => s.cv_accel);
    if (cv[0] > cv[1] && cv[1] > cv[2]) alerts.push('Your consistency (CV) has increased — your reps are becoming more variable.');

    const pw = last3.map(s => s.power_wkg);
    if (pw[0] < pw[1] && pw[1] < pw[2]) alerts.push('Your power output has decreased over your last 3 sessions.');

    const rc = last3.map(s => s.rep_count);
    if (rc[0] < rc[1] && rc[1] < rc[2]) alerts.push('Your rep count has declined over your last 3 sessions.');

    alerts.forEach(msg => {
        container.innerHTML += `<div class="trend-alert">${msg}</div>`;
    });
}

function renderSessionList(sessions) {
    const listContainer = document.getElementById('session-list-items');
    if (sessions.length === 0) {
        listContainer.innerHTML = '<div class="empty-dashboard">No sessions yet. Complete a test to get started.</div>';
        return;
    }

    const sorted = [...sessions].sort((a, b) => new Date(b.date) - new Date(a.date));
    listContainer.innerHTML = sorted.map(s => {
        const d = new Date(s.date);
        const dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        const timeStr = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        const flagCount = Object.values(s.flags).filter(f =>
            f === 'low' || f === 'below_range' || f === 'high' || f === 'significant_decline'
        ).length;
        const flagText = flagCount > 0 ? `${flagCount} flag${flagCount > 1 ? 's' : ''}` : '';

        return `<div class="session-item" data-session-id="${s.id}">
                <div class="session-info" onclick="viewSession('${s.id}')">
                    <div class="session-date">${dateStr} at ${timeStr}</div>
                    <div class="session-stats">${s.rep_count} reps &middot; ${s.power_wkg.toFixed(1)} W/kg</div>
                    ${flagText ? `<div class="session-flags">${flagText}</div>` : ''}
                </div>
                <button class="session-delete" onclick="event.stopPropagation(); confirmDeleteSession('${s.id}')">Delete</button>
            </div>`;
    }).join('');
}

function viewSession(sessionId) {
    const sessions = getSessions();
    const session = sessions.find(s => s.id === sessionId);
    if (!session) return;

    const displaySession = {
        repCount: session.rep_count,
        meanTime: session.mean_time_per_rep,
        power: session.power_wkg,
        cvAccel: session.cv_accel,
        fatigueSlope: session.fatigue_slope,
        flags: session.flags,
        perRep: session.per_rep.map(r => ({
            peak_accel: r.peak_accel,
            peak_gyro: r.peak_gyro,
            duration: r.duration
        }))
    };

    btnResultsBack.style.display = 'flex';
    btnSave.style.display = 'none';
    btnNewTest.textContent = 'New Test';

    renderResults(displaySession, session.date);
    showScreen(screenResults);
}

function confirmDeleteSession(sessionId) {
    if (confirm('Delete this session? This cannot be undone.')) {
        deleteSession(sessionId);
        renderDashboard();
    }
}

// Metric tab switching
document.getElementById('metric-tabs').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn || !btn.dataset.metric) return;
    document.querySelectorAll('#metric-tabs button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentMetric = btn.dataset.metric;
    renderTrendChart(getSessions());
});

// =============================================================
// EVENT LISTENERS
// =============================================================
btnStart.addEventListener('click', () => {
    if (typeof DeviceMotionEvent === 'undefined') {
        alert('Motion sensors are not available on this device.');
        return;
    }
    startRealSensors();
});

btnNewTest.addEventListener('click', () => {
    btnResultsBack.style.display = 'none';
    btnSave.style.display = '';
    showScreen(screenPretest);
    timerDisplay.textContent = '30';
});

btnSave.addEventListener('click', () => {
    if (!lastSessionData) return;
    saveSessionToStorage(lastSessionData);
    lastSessionData = null;
    timerDisplay.textContent = '30';
    showDashboard();
});

btnDashboard.addEventListener('click', () => {
    showDashboard();
});

btnSettings.addEventListener('click', () => {
    const profile = getProfile();
    if (profile) {
        document.getElementById('setup-height-cm').value = Math.round(profile.height_m * 100);
        if (profile.age_group) document.getElementById('setup-age').value = profile.age_group;
        if (profile.sex) document.getElementById('setup-sex').value = profile.sex;
    }
    showScreen(screenSetup);
});

btnDashBack.addEventListener('click', () => {
    showScreen(screenPretest);
});

btnResultsBack.addEventListener('click', () => {
    btnResultsBack.style.display = 'none';
    btnSave.style.display = '';
    showDashboard();
});

// =============================================================
// APP INITIALIZATION
// =============================================================
function initApp() {
    initSetup();
    const profile = getProfile();
    if (!profile) {
        showScreen(screenSetup);
    } else {
        showScreen(screenPretest);
    }
}

initApp();
</script>

</body>
</html>
