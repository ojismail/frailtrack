<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Steady</title>
    <style>
/* ============================================
   Steady — Apple Health-Inspired Design
   ============================================ */

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    -webkit-tap-highlight-color: transparent;
}

body {
    font-family: -apple-system, 'SF Pro Display', 'SF Pro Text', BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 17px;
    line-height: 1.47;
    color: #1C1C1E;
    background-color: #000000;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

h1 {
    font-size: 34px;
    font-weight: 700;
    line-height: 1.12;
    letter-spacing: 0.37px;
    color: #FFFFFF;
    margin-bottom: 4px;
}

.subtitle {
    font-size: 15px;
    color: rgba(255,255,255,0.55);
    font-weight: 400;
    margin-bottom: 28px;
}

.container {
    width: 100%;
    max-width: 428px;
    padding: 20px;
    padding-top: env(safe-area-inset-top, 20px);
}

/* --- App Header --- */
.app-header {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-bottom: 4px;
}

.logo-mark {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    border-radius: 12px;
    background: linear-gradient(135deg, #30D158, #34C759);
    color: #FFFFFF;
    font-size: 22px;
    font-weight: 700;
    line-height: 1;
    flex-shrink: 0;
    box-shadow: 0 2px 8px rgba(48, 209, 88, 0.3);
}

/* --- Screens --- */
.screen {
    display: none;
    width: 100%;
    opacity: 0;
    transition: opacity 0.25s ease;
}
.screen.active {
    display: flex;
    flex-direction: column;
    align-items: center;
    opacity: 1;
}

/* --- Educational Info Card --- */
.edu-info {
    background: #1C1C1E;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 16px;
    font-size: 15px;
    color: rgba(255,255,255,0.6);
    line-height: 1.53;
    width: 100%;
}

/* --- Instructions --- */
.instructions {
    font-size: 15px;
    color: rgba(255,255,255,0.85);
    line-height: 1.53;
    margin-bottom: 20px;
    padding: 20px;
    background: #1C1C1E;
    border-radius: 16px;
    width: 100%;
}

.instructions strong {
    font-size: 13px;
    font-weight: 600;
    color: rgba(255,255,255,0.4);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* --- Buttons --- */
.btn {
    display: block;
    width: 100%;
    padding: 16px 24px;
    font-family: inherit;
    font-size: 17px;
    font-weight: 600;
    line-height: 1.2;
    border: none;
    border-radius: 14px;
    cursor: pointer;
    text-align: center;
    transition: opacity 0.15s ease, transform 0.1s ease;
    margin-bottom: 12px;
    -webkit-appearance: none;
}
.btn:active {
    opacity: 0.7;
    transform: scale(0.98);
}

.btn-primary {
    background: linear-gradient(135deg, #30D158, #34C759);
    color: #FFFFFF;
    box-shadow: 0 2px 12px rgba(48,209,88,0.3);
}
.btn-primary:hover {
    opacity: 0.9;
}

.btn-secondary {
    background-color: #2C2C2E;
    color: #FFFFFF;
}
.btn-secondary:hover {
    background-color: #3A3A3C;
}

.btn-link {
    background: none;
    color: #30D158;
    font-size: 15px;
    font-weight: 400;
    text-decoration: none;
    padding: 10px;
    border: none;
    cursor: pointer;
}
.btn-link:active {
    opacity: 0.5;
}

/* --- Active Test Screen --- */
.timer-display {
    font-size: 96px;
    font-weight: 200;
    color: #FFFFFF;
    text-align: center;
    letter-spacing: -2px;
    margin: 24px 0;
    font-variant-numeric: tabular-nums;
}

/* --- Live Accel Graph --- */
.live-graph-container {
    width: 100%;
    background: #1C1C1E;
    border-radius: 16px;
    padding: 16px 20px;
    margin-bottom: 16px;
}
.live-graph-container canvas {
    width: 100%;
    height: 140px;
    display: block;
    border-radius: 8px;
}
.live-graph-label {
    font-size: 11px;
    color: rgba(255,255,255,0.4);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    text-align: center;
    margin-top: 8px;
    font-weight: 500;
}

.sensor-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: rgba(255,255,255,0.55);
    font-weight: 500;
    margin-bottom: 8px;
}

.pulse-dot {
    width: 8px;
    height: 8px;
    background: #30D158;
    border-radius: 50%;
    animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.4; transform: scale(1.4); }
}

/* --- Results Screen --- */
.results-header {
    text-align: center;
    margin-bottom: 20px;
    width: 100%;
}
.results-header h2 {
    font-size: 28px;
    font-weight: 700;
    color: #FFFFFF;
    margin-bottom: 2px;
}
.results-header .date {
    font-size: 15px;
    color: rgba(255,255,255,0.55);
}

/* Tier 1: Rep Count */
.tier-rep {
    background: #1C1C1E;
    border-radius: 16px;
    padding: 28px 24px;
    text-align: center;
    margin-bottom: 12px;
    width: 100%;
}
.tier-rep .big-number {
    font-size: 64px;
    font-weight: 700;
    color: #30D158;
    line-height: 1;
    letter-spacing: -1px;
}
.tier-rep .label {
    font-size: 15px;
    color: rgba(255,255,255,0.55);
    margin-top: 4px;
    font-weight: 500;
}
.tier-rep .norm-range {
    font-size: 13px;
    color: rgba(255,255,255,0.35);
    margin-top: 8px;
}

/* Tier 2: Power */
.tier-power {
    background: #1C1C1E;
    border-radius: 16px;
    padding: 20px 24px;
    margin-bottom: 12px;
    width: 100%;
    display: flex;
    align-items: center;
    gap: 16px;
}
.tier-power .power-value {
    font-size: 36px;
    font-weight: 700;
    min-width: 110px;
    letter-spacing: -0.5px;
}
.tier-power .power-info {
    flex: 1;
}
.tier-power .power-label {
    font-size: 15px;
    font-weight: 600;
    color: #FFFFFF;
}
.tier-power .power-note {
    font-size: 13px;
    color: rgba(255,255,255,0.35);
    margin-top: 2px;
}

/* Tier 3: Quality Cards */
.quality-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    width: 100%;
    margin-bottom: 20px;
}

.quality-card {
    background: #1C1C1E;
    border-radius: 16px;
    padding: 16px;
    border-left: 3px solid #3A3A3C;
}
.quality-card.status-green { border-left-color: #30D158; }
.quality-card.status-yellow { border-left-color: #FF9F0A; }
.quality-card.status-red { border-left-color: #FF453A; }

.quality-card .card-title {
    font-size: 11px;
    font-weight: 600;
    color: rgba(255,255,255,0.55);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 2px;
}
.quality-card .card-dimension {
    font-size: 11px;
    color: rgba(255,255,255,0.35);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}
.quality-card .card-status {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 4px;
}
.quality-card .card-detail {
    font-size: 13px;
    color: rgba(255,255,255,0.55);
    line-height: 1.38;
}
.quality-card .mini-chart {
    margin: 6px 0;
    width: 100%;
    overflow: visible;
}

.status-msg {
    font-size: 15px;
    color: rgba(255,255,255,0.55);
    margin-top: 16px;
    text-align: center;
}

/* Color helpers */
.text-green { color: #30D158; }
.text-yellow { color: #FF9F0A; }
.text-red { color: #FF453A; }

/* --- Setup Screen --- */
.setup-card {
    background: #1C1C1E;
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 20px;
    width: 100%;
}
.setup-card label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: rgba(255,255,255,0.55);
    text-transform: uppercase;
    letter-spacing: 0.4px;
    margin-bottom: 6px;
    margin-top: 20px;
}
.setup-card label:first-child { margin-top: 0; }
.setup-card input,
.setup-card select {
    width: 100%;
    padding: 12px 14px;
    font-family: inherit;
    font-size: 17px;
    color: #FFFFFF;
    border: 1px solid #3A3A3C;
    border-radius: 10px;
    background: #2C2C2E;
    outline: none;
    -webkit-appearance: none;
    appearance: none;
    transition: border-color 0.2s ease;
}
.setup-card input:focus,
.setup-card select:focus {
    border-color: #30D158;
}
.setup-card input::placeholder {
    color: rgba(255,255,255,0.3);
}
.setup-card select option {
    background: #2C2C2E;
    color: #FFFFFF;
}
.unit-toggle {
    display: flex;
    background: #2C2C2E;
    border-radius: 9px;
    padding: 2px;
    margin-bottom: 12px;
}
.unit-toggle button {
    flex: 1;
    padding: 8px;
    font-family: inherit;
    font-size: 13px;
    font-weight: 600;
    border: none;
    border-radius: 7px;
    background: transparent;
    color: rgba(255,255,255,0.55);
    cursor: pointer;
    transition: all 0.2s ease;
}
.unit-toggle button.active {
    background: #3A3A3C;
    color: #FFFFFF;
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}
.ft-in-row { display: flex; gap: 10px; }
.ft-in-row input { flex: 1; }
.optional-label {
    font-size: 12px;
    color: rgba(255,255,255,0.3);
    font-weight: 400;
    text-transform: none;
    letter-spacing: 0;
}

/* --- Dashboard Screen --- */
.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    margin-bottom: 20px;
}
.dashboard-header h2 {
    font-size: 22px;
    font-weight: 700;
    color: #FFFFFF;
}
.metric-tabs {
    display: flex;
    background: #2C2C2E;
    border-radius: 9px;
    padding: 2px;
    margin-bottom: 16px;
    width: 100%;
}
.metric-tabs button {
    flex: 1;
    min-width: 0;
    padding: 7px 4px;
    font-family: inherit;
    font-size: 13px;
    font-weight: 600;
    border: none;
    border-radius: 7px;
    background: transparent;
    color: rgba(255,255,255,0.55);
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s ease;
}
.metric-tabs button.active {
    background: #3A3A3C;
    color: #FFFFFF;
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}
.chart-container {
    background: #1C1C1E;
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 16px;
    width: 100%;
    text-align: center;
}
.chart-container .chart-msg {
    font-size: 15px;
    color: rgba(255,255,255,0.35);
    padding: 40px 20px;
}
.trend-alerts { width: 100%; margin-bottom: 12px; }
.trend-alert {
    background: #1C1C1E;
    border-radius: 12px;
    padding: 14px 16px;
    font-size: 15px;
    color: rgba(255,255,255,0.55);
    margin-bottom: 8px;
    line-height: 1.47;
}
.session-list { width: 100%; }
.session-list h3 {
    font-size: 13px;
    font-weight: 600;
    color: rgba(255,255,255,0.55);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}
.session-item {
    padding: 14px 0;
    border-bottom: 0.5px solid #2C2C2E;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: opacity 0.15s ease;
}
.session-item:active { opacity: 0.6; }
.session-item .session-info { flex: 1; }
.session-item .session-date { font-size: 17px; font-weight: 400; color: #FFFFFF; }
.session-item .session-stats { font-size: 13px; color: rgba(255,255,255,0.55); margin-top: 2px; }
.session-item .session-flags { font-size: 13px; color: #FF9F0A; margin-top: 2px; font-weight: 500; }
.session-item .session-delete {
    padding: 6px 12px;
    font-size: 13px;
    color: #FF453A;
    background: none;
    border: none;
    cursor: pointer;
    margin-left: 12px;
    flex-shrink: 0;
    font-weight: 500;
    border-radius: 8px;
    transition: background 0.15s ease;
}
.session-item .session-delete:active { background: rgba(255,69,58,0.12); }
.btn-back-nav {
    background: none;
    border: none;
    color: #30D158;
    font-family: inherit;
    font-size: 17px;
    cursor: pointer;
    padding: 4px 0;
}
.empty-dashboard {
    text-align: center;
    padding: 60px 20px;
    color: rgba(255,255,255,0.35);
    font-size: 17px;
}

/* --- Loading Overlay --- */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 100;
}
.loading-overlay p {
    font-size: 17px;
    color: rgba(255,255,255,0.55);
    margin-top: 16px;
    font-weight: 500;
}
.spinner {
    width: 36px;
    height: 36px;
    border: 3px solid #3A3A3C;
    border-top: 3px solid #30D158;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
    </style>
</head>
<body>

<div class="container">
    <div class="app-header">
        <div class="logo-mark">S</div>
        <div>
            <h1>Steady</h1>
            <p class="subtitle">Functional Fitness Analysis</p>
        </div>
    </div>

    <!-- Screen: Setup (first visit only) -->
    <div id="screen-setup" class="screen">
        <div style="text-align:center; margin-bottom:20px;">
            <p style="font-size:17px; color:rgba(255,255,255,0.55);">Let's set up your profile to personalize your results.</p>
        </div>
        <div class="setup-card">
            <label>Height <span style="color:#FF453A;">*</span></label>
            <div class="unit-toggle" id="unit-toggle">
                <button class="active" data-unit="cm">cm</button>
                <button data-unit="ftin">ft / in</button>
            </div>
            <div id="height-cm-input">
                <input type="number" id="setup-height-cm" placeholder="e.g. 170" min="100" max="250" inputmode="numeric">
            </div>
            <div id="height-ftin-input" style="display:none;">
                <div class="ft-in-row">
                    <input type="number" id="setup-height-ft" placeholder="ft" min="3" max="7" inputmode="numeric">
                    <input type="number" id="setup-height-in" placeholder="in" min="0" max="11" inputmode="numeric">
                </div>
            </div>

            <label>Age Group <span class="optional-label">(optional)</span></label>
            <select id="setup-age">
                <option value="">Select</option>
                <option value="60-64">60-64</option>
                <option value="65-69">65-69</option>
                <option value="70-74">70-74</option>
                <option value="75-79">75-79</option>
                <option value="80-84">80-84</option>
                <option value="85-89">85-89</option>
                <option value="90-94">90-94</option>
            </select>

            <label>Sex <span class="optional-label">(optional)</span></label>
            <select id="setup-sex">
                <option value="">Select</option>
                <option value="female">Female</option>
                <option value="male">Male</option>
            </select>
        </div>
        <button class="btn btn-primary" id="btn-get-started">Get Started</button>
    </div>

    <!-- Screen: Pre-Test -->
    <div id="screen-pretest" class="screen">
        <div class="edu-info">
            The 30-Second Chair Stand measures your lower body strength and endurance — key indicators of functional fitness and independence.
        </div>
        <div class="instructions">
            <strong>How It Works</strong><br>
            Place your phone in your waistband at the front hip. Sit in a standard chair with your arms crossed over your chest. When you're ready, tap Start and stand up and sit down as many times as you can in 30 seconds.
        </div>
        <button class="btn btn-primary" id="btn-start">Start Test</button>
        <button class="btn btn-link" id="btn-dashboard">View Dashboard</button>
        <button class="btn btn-link" id="btn-settings">Settings</button>
    </div>

    <!-- Screen: Active Test -->
    <div id="screen-test" class="screen">
        <div class="sensor-indicator">
            <div class="pulse-dot"></div>
            <span id="sensor-status">Recording</span>
        </div>
        <div class="timer-display" id="timer">30</div>
        <div class="live-graph-container">
            <div class="live-graph-label">Acceleration</div>
            <canvas id="live-graph" width="380" height="140"></canvas>
        </div>
    </div>

    <!-- Screen: Results -->
    <div id="screen-results" class="screen">
        <button class="btn-back-nav" id="btn-results-back" style="display:none; align-self:flex-start; margin-bottom:8px;">&#8592; Dashboard</button>

        <div class="results-header">
            <h2>Summary</h2>
            <div class="date" id="result-date"></div>
        </div>

        <!-- Tier 1: Rep Count -->
        <div class="tier-rep">
            <div class="big-number" id="result-reps">&mdash;</div>
            <div class="label">Repetitions in 30 seconds</div>
            <div class="norm-range" id="result-norm"></div>
        </div>

        <!-- Tier 2: Power -->
        <div class="tier-power">
            <div class="power-value" id="result-power">&mdash;</div>
            <div class="power-info">
                <div class="power-label">Relative Muscle Power</div>
                <div class="power-status" id="result-power-status"></div>
                <div class="power-note">Estimated from your height and rep cadence</div>
            </div>
        </div>

        <!-- Tier 3: Quality Cards -->
        <div class="quality-grid">
            <div class="quality-card" id="card-accel">
                <div class="card-title">Push-off Force</div>
                <div class="card-dimension">Strength</div>
                <div class="mini-chart" id="chart-accel"></div>
                <div class="card-status" id="status-accel"></div>
                <div class="card-detail" id="detail-accel"></div>
            </div>

            <div class="quality-card" id="card-gyro">
                <div class="card-title">Rotational Speed</div>
                <div class="card-dimension">Mobility</div>
                <div class="mini-chart" id="chart-gyro"></div>
                <div class="card-status" id="status-gyro"></div>
                <div class="card-detail" id="detail-gyro"></div>
            </div>

            <div class="quality-card" id="card-cv">
                <div class="card-title">Consistency</div>
                <div class="card-dimension">Stability</div>
                <div class="card-status" id="status-cv"></div>
                <div class="card-detail" id="detail-cv"></div>
            </div>

            <div class="quality-card" id="card-fatigue">
                <div class="card-title">Fatigue Trend</div>
                <div class="card-dimension">Endurance</div>
                <div class="mini-chart" id="chart-fatigue"></div>
                <div class="card-status" id="status-fatigue"></div>
                <div class="card-detail" id="detail-fatigue"></div>
            </div>
        </div>

        <button class="btn btn-primary" id="btn-save">Save &amp; View Dashboard</button>
        <button class="btn btn-secondary" id="btn-newtest">New Test</button>
    </div>

    <!-- Screen: Dashboard -->
    <div id="screen-dashboard" class="screen">
        <div class="dashboard-header">
            <button class="btn-back-nav" id="btn-dash-back">&#8592; Back</button>
            <h2>Dashboard</h2>
            <div style="width:60px;"></div>
        </div>

        <div class="metric-tabs" id="metric-tabs">
            <button class="active" data-metric="rep_count">Reps</button>
            <button data-metric="power_wkg">Power</button>
            <button data-metric="mean_peak_accel">Accel</button>
            <button data-metric="cv_accel">CV</button>
            <button data-metric="fatigue_slope">Fatigue</button>
        </div>
        <div class="chart-container" id="trend-chart-container">
            <div class="chart-msg">Complete your first test to start tracking trends.</div>
        </div>

        <div class="trend-alerts" id="trend-alerts"></div>

        <div class="session-list">
            <h3>History</h3>
            <div id="session-list-items"></div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display:none;">
        <div class="spinner"></div>
        <p>Analyzing</p>
    </div>
</div>

<script>

// =============================================================
// PEAK DETECTION CONSTANTS (easy to tune)
// =============================================================
const PEAK_THRESHOLD = 1.15;   // g's — accel_mag must exceed this
const MIN_PEAK_GAP = 35;       // samples (0.7s at 50Hz)
const LOCAL_MAX_RANGE = 15;    // samples — local max checked ±15
const SMOOTH_WINDOW = 15;      // moving average window (0.3s at 50Hz)
const GRAPH_SAMPLES = 250;     // 5 seconds at 50Hz
const GRAPH_Y_MAX = 3.0;       // g's — Y axis max

// =============================================================
// AUDIO — robust cross-platform beep (iOS + Android + Desktop)
// =============================================================
let audioCtx = null;

function ensureAudioContext() {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === 'suspended') {
        audioCtx.resume();
    }
    return audioCtx;
}

// Warm up audio on every user tap so iOS doesn't suspend it
document.addEventListener('touchstart', ensureAudioContext, { passive: true });
document.addEventListener('click', ensureAudioContext);

function playBeep(frequency = 800, duration = 200) {
    try {
        const ctx = ensureAudioContext();
        const oscillator = ctx.createOscillator();
        const gainNode = ctx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(ctx.destination);
        oscillator.frequency.value = frequency;
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
        // Fade out to avoid click/pop
        gainNode.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration / 1000);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + duration / 1000 + 0.05);
    } catch (e) {
        console.warn('Audio beep failed:', e);
    }
}

// =============================================================
// APP STATE
// =============================================================
let sensorBuffer = [];
let isRunning = false;
let timerInterval = null;
let sensorListener = null;
let timeRemaining = 30;
let graphInterval = null;

// =============================================================
// DOM REFS
// =============================================================
const screenPretest = document.getElementById('screen-pretest');
const screenTest = document.getElementById('screen-test');
const screenResults = document.getElementById('screen-results');
const timerDisplay = document.getElementById('timer');
const sensorStatus = document.getElementById('sensor-status');

const btnStart = document.getElementById('btn-start');
const btnDashboard = document.getElementById('btn-dashboard');
const btnSave = document.getElementById('btn-save');
const btnNewTest = document.getElementById('btn-newtest');

// Phase 6 DOM refs
const screenSetup = document.getElementById('screen-setup');
const screenDashboard = document.getElementById('screen-dashboard');
const btnGetStarted = document.getElementById('btn-get-started');
const btnSettings = document.getElementById('btn-settings');
const btnDashBack = document.getElementById('btn-dash-back');
const btnResultsBack = document.getElementById('btn-results-back');

// Live graph
const liveCanvas = document.getElementById('live-graph');
const liveCtx = liveCanvas.getContext('2d');

// Last session data (for saving later)
let lastSessionData = null;

// =============================================================
// NORMATIVE REFERENCE TABLE (Jones et al., 1999)
// =============================================================
const NORMATIVE_TABLE = {
    '60-64': { female: [12, 17], male: [14, 19] },
    '65-69': { female: [11, 16], male: [12, 18] },
    '70-74': { female: [10, 15], male: [12, 17] },
    '75-79': { female: [10, 15], male: [11, 17] },
    '80-84': { female: [9, 14],  male: [10, 15] },
    '85-89': { female: [8, 13],  male: [8, 14] },
    '90-94': { female: [4, 11],  male: [7, 12] }
};

// =============================================================
// PERSISTENCE (Phase 6)
// =============================================================
function getProfile() {
    try {
        const raw = localStorage.getItem('steady_profile');
        return raw ? JSON.parse(raw) : null;
    } catch (e) { return null; }
}

function saveProfile(profile) {
    localStorage.setItem('steady_profile', JSON.stringify(profile));
}

function getSessions() {
    try {
        const raw = localStorage.getItem('steady_sessions');
        return raw ? JSON.parse(raw) : [];
    } catch (e) { return []; }
}

function saveSessionToStorage(sessionData) {
    const sessions = getSessions();
    const now = new Date();
    const entry = {
        id: 'session_' + Date.now(),
        date: now.toISOString().slice(0, 19),
        rep_count: sessionData.repCount,
        power_wkg: parseFloat(sessionData.power.toFixed(2)),
        mean_time_per_rep: parseFloat(sessionData.meanTime.toFixed(2)),
        per_rep: sessionData.perRep.map((r, i) => ({
            rep: i + 1,
            peak_accel: parseFloat(r.peak_accel.toFixed(2)),
            peak_gyro: parseFloat(r.peak_gyro.toFixed(2)),
            duration: parseFloat(r.duration.toFixed(2))
        })),
        cv_accel: parseFloat(sessionData.cvAccel.toFixed(4)),
        fatigue_slope: parseFloat(sessionData.fatigueSlope.toFixed(4)),
        flags: { ...sessionData.flags }
    };
    sessions.push(entry);
    try {
        localStorage.setItem('steady_sessions', JSON.stringify(sessions));
    } catch (e) {
        if (e.name === 'QuotaExceededError' || e.code === 22) {
            alert('Storage is full. Delete old sessions from the Dashboard to save new ones.');
        } else {
            console.error('Error saving session:', e);
            alert('Could not save session. Please try again.');
        }
    }
    return entry;
}

function deleteSession(sessionId) {
    let sessions = getSessions();
    sessions = sessions.filter(s => s.id !== sessionId);
    localStorage.setItem('steady_sessions', JSON.stringify(sessions));
}

function getNormativeRange(ageGroup, sex) {
    if (!ageGroup || !sex) return null;
    const group = NORMATIVE_TABLE[ageGroup];
    return group ? (group[sex] || null) : null;
}

// =============================================================
// SCREEN MANAGEMENT
// =============================================================
function showScreen(screen) {
    const current = document.querySelector('.screen.active');
    if (current && current !== screen) {
        current.style.opacity = '0';
        setTimeout(() => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screen.classList.add('active');
            screen.offsetHeight;
            screen.style.opacity = '1';
        }, 200);
    } else {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        screen.classList.add('active');
        screen.style.opacity = '1';
    }
}

// =============================================================
// TIMER
// =============================================================
function startTimer() {
    timeRemaining = 30;
    timerDisplay.textContent = timeRemaining;
    timerInterval = setInterval(() => {
        timeRemaining--;
        timerDisplay.textContent = Math.max(0, timeRemaining);
        if (timeRemaining <= 0) {
            stopTest();
        }
    }, 1000);
}

// =============================================================
// LIVE ACCELERATION GRAPH (Canvas)
// =============================================================
function drawLiveGraph() {
    const canvas = liveCanvas;
    const ctx = liveCtx;

    // Size canvas to actual CSS pixel dimensions
    const rect = canvas.parentElement.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    const w = rect.width - 40; // account for padding
    const h = 140;
    canvas.width = w * dpr;
    canvas.height = h * dpr;
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

    // Clear
    ctx.clearRect(0, 0, w, h);

    // Get last GRAPH_SAMPLES samples of accel_mag
    const start = Math.max(0, sensorBuffer.length - GRAPH_SAMPLES);
    const samples = [];
    for (let i = start; i < sensorBuffer.length; i++) {
        const s = sensorBuffer[i];
        samples.push(Math.sqrt(s.ax * s.ax + s.ay * s.ay + s.az * s.az));
    }

    const padLeft = 32;
    const padRight = 5;
    const padTop = 8;
    const padBottom = 16;
    const plotW = w - padLeft - padRight;
    const plotH = h - padTop - padBottom;

    // Y axis labels
    ctx.fillStyle = 'rgba(255,255,255,0.4)';
    ctx.font = '10px -apple-system, sans-serif';
    ctx.textAlign = 'right';
    ctx.fillText(GRAPH_Y_MAX.toFixed(1), padLeft - 4, padTop + 8);
    ctx.fillText('0', padLeft - 4, padTop + plotH);
    const midY = GRAPH_Y_MAX / 2;
    ctx.fillText(midY.toFixed(1), padLeft - 4, padTop + plotH / 2 + 4);

    // Grid lines
    ctx.beginPath();
    ctx.strokeStyle = 'rgba(255,255,255,0.1)';
    ctx.lineWidth = 0.5;
    ctx.moveTo(padLeft, padTop + plotH / 2);
    ctx.lineTo(padLeft + plotW, padTop + plotH / 2);
    ctx.stroke();

    // Threshold dashed line
    const threshY = padTop + plotH - (PEAK_THRESHOLD / GRAPH_Y_MAX) * plotH;
    ctx.beginPath();
    ctx.setLineDash([4, 3]);
    ctx.strokeStyle = '#FF9F0A';
    ctx.lineWidth = 1;
    ctx.moveTo(padLeft, threshY);
    ctx.lineTo(padLeft + plotW, threshY);
    ctx.stroke();
    ctx.setLineDash([]);

    // Threshold label
    ctx.fillStyle = '#FF9F0A';
    ctx.textAlign = 'left';
    ctx.font = '9px -apple-system, sans-serif';
    ctx.fillText(PEAK_THRESHOLD + 'g', padLeft + plotW - 28, threshY - 3);

    // Draw data
    if (samples.length < 2) return;

    ctx.beginPath();
    ctx.strokeStyle = '#30D158';
    ctx.lineWidth = 1.5;

    const xStep = plotW / GRAPH_SAMPLES;
    const xOffset = (GRAPH_SAMPLES - samples.length) * xStep; // right-align data

    for (let i = 0; i < samples.length; i++) {
        const x = padLeft + xOffset + i * xStep;
        const val = Math.min(samples[i], GRAPH_Y_MAX);
        const y = padTop + plotH - (val / GRAPH_Y_MAX) * plotH;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    }
    ctx.stroke();

    // Fill area above threshold in light orange
    ctx.beginPath();
    ctx.fillStyle = 'rgba(255, 159, 10, 0.1)';
    let inAbove = false;
    for (let i = 0; i < samples.length; i++) {
        const x = padLeft + xOffset + i * xStep;
        const val = Math.min(samples[i], GRAPH_Y_MAX);
        const y = padTop + plotH - (val / GRAPH_Y_MAX) * plotH;
        if (val >= PEAK_THRESHOLD) {
            if (!inAbove) {
                ctx.moveTo(x, threshY);
                inAbove = true;
            }
            ctx.lineTo(x, y);
        } else {
            if (inAbove) {
                ctx.lineTo(x, threshY);
                ctx.closePath();
                ctx.fill();
                ctx.beginPath();
                inAbove = false;
            }
        }
    }
    if (inAbove) {
        const lastX = padLeft + xOffset + (samples.length - 1) * xStep;
        ctx.lineTo(lastX, threshY);
        ctx.closePath();
        ctx.fill();
    }

    // Current value text
    if (samples.length > 0) {
        const current = samples[samples.length - 1];
        ctx.fillStyle = current >= PEAK_THRESHOLD ? '#FF9F0A' : '#30D158';
        ctx.font = 'bold 14px -apple-system, sans-serif';
        ctx.textAlign = 'right';
        ctx.fillText(current.toFixed(2) + 'g', padLeft + plotW, padTop + 14);
    }
}

function startGraphUpdates() {
    graphInterval = setInterval(drawLiveGraph, 100);
}

function stopGraphUpdates() {
    if (graphInterval) { clearInterval(graphInterval); graphInterval = null; }
}

// =============================================================
// SMOOTHED ACCEL_MAG COMPUTATION
// =============================================================
function computeSmoothedAccelMag(buffer) {
    const raw = buffer.map(s => Math.sqrt(s.ax * s.ax + s.ay * s.ay + s.az * s.az));
    const smoothed = new Array(raw.length);
    const half = Math.floor(SMOOTH_WINDOW / 2);
    for (let i = 0; i < raw.length; i++) {
        let sum = 0, count = 0;
        for (let j = Math.max(0, i - half); j <= Math.min(raw.length - 1, i + half); j++) {
            sum += raw[j];
            count++;
        }
        smoothed[i] = sum / count;
    }
    return smoothed;
}

// =============================================================
// PEAK DETECTION (on full buffer, post-test)
// =============================================================
function detectPeaks(buffer) {
    if (buffer.length < SMOOTH_WINDOW) return [];

    const smoothed = computeSmoothedAccelMag(buffer);
    const peaks = [];
    let lastPeakIdx = -MIN_PEAK_GAP;

    for (let i = LOCAL_MAX_RANGE; i < smoothed.length - LOCAL_MAX_RANGE; i++) {
        if (smoothed[i] < PEAK_THRESHOLD) continue;
        if (i - lastPeakIdx < MIN_PEAK_GAP) continue;

        let isMax = true;
        for (let j = i - LOCAL_MAX_RANGE; j <= i + LOCAL_MAX_RANGE; j++) {
            if (j !== i && smoothed[j] > smoothed[i]) {
                isMax = false;
                break;
            }
        }
        if (!isMax) continue;

        peaks.push({ sampleIndex: i, value: smoothed[i] });
        lastPeakIdx = i;
    }

    return peaks;
}

function peaksToEvents(peaks) {
    return peaks.map((p, idx) => ({
        rep: idx + 1,
        start_sample: p.sampleIndex - LOCAL_MAX_RANGE,
        end_sample: p.sampleIndex + LOCAL_MAX_RANGE,
        peak_sample: p.sampleIndex,
        start_time: (p.sampleIndex - LOCAL_MAX_RANGE) / 50,
        end_time: (p.sampleIndex + LOCAL_MAX_RANGE) / 50
    }));
}

// =============================================================
// REAL SENSOR MODE
// =============================================================
async function startRealSensors() {
    isRunning = true;
    sensorBuffer = [];

    // Request permission (iOS)
    if (typeof DeviceMotionEvent !== 'undefined' &&
        typeof DeviceMotionEvent.requestPermission === 'function') {
        try {
            const permission = await DeviceMotionEvent.requestPermission();
            if (permission !== 'granted') {
                alert('Sensor permission denied. Please allow motion access.');
                isRunning = false;
                return;
            }
        } catch (e) {
            alert('Could not request sensor permission: ' + e.message);
            isRunning = false;
            return;
        }
    }

    sensorStatus.textContent = 'Recording';
    showScreen(screenTest);
    startTimer();
    startGraphUpdates();

    let nullDataCount = 0;
    let receivedData = false;

    sensorListener = function(event) {
        if (!isRunning) return;

        const accel = event.accelerationIncludingGravity;
        const rot = event.rotationRate;

        if (!accel || accel.x === null || !rot || rot.alpha === null) {
            nullDataCount++;
            if (nullDataCount > 10 && !receivedData) {
                sensorStatus.textContent = 'Waiting for sensor data';
            }
            return;
        }

        receivedData = true;
        sensorBuffer.push({
            ax: accel.x / 9.81,
            ay: accel.y / 9.81,
            az: accel.z / 9.81,
            gx: rot.alpha * Math.PI / 180,
            gy: rot.beta * Math.PI / 180,
            gz: rot.gamma * Math.PI / 180,
            timestamp: event.timeStamp || performance.now()
        });
    };

    window.addEventListener('devicemotion', sensorListener);
}

// =============================================================
// RESAMPLE TO 50Hz
// =============================================================
function resampleTo50Hz(buffer) {
    if (buffer.length < 2) return { resampled: buffer, actualRate: 0 };

    const startTime = buffer[0].timestamp;
    const endTime = buffer[buffer.length - 1].timestamp;
    const durationMs = endTime - startTime;
    const actualRate = (buffer.length - 1) / (durationMs / 1000);

    console.log(`Actual sample rate: ${actualRate.toFixed(1)} Hz`);

    if (actualRate >= 45 && actualRate <= 55) {
        return { resampled: buffer, actualRate };
    }

    const targetInterval = 20;
    const targetCount = Math.round(durationMs / targetInterval) + 1;
    const resampled = [];
    let bufIdx = 0;

    for (let i = 0; i < targetCount; i++) {
        const targetTime = startTime + i * targetInterval;
        while (bufIdx < buffer.length - 2 && buffer[bufIdx + 1].timestamp < targetTime) bufIdx++;

        const s0 = buffer[bufIdx];
        const s1 = buffer[Math.min(bufIdx + 1, buffer.length - 1)];
        const dt = s1.timestamp - s0.timestamp;
        const t = dt > 0 ? (targetTime - s0.timestamp) / dt : 0;

        resampled.push({
            ax: s0.ax + t * (s1.ax - s0.ax),
            ay: s0.ay + t * (s1.ay - s0.ay),
            az: s0.az + t * (s1.az - s0.az),
            gx: s0.gx + t * (s1.gx - s0.gx),
            gy: s0.gy + t * (s1.gy - s0.gy),
            gz: s0.gz + t * (s1.gz - s0.gz),
            timestamp: targetTime
        });
    }

    console.log(`Resampled from ${buffer.length} to ${resampled.length} samples (50Hz).`);
    return { resampled, actualRate };
}

// =============================================================
// GRAVITY REMOVAL
// =============================================================
function removeGravity(buffer) {
    const alpha = 0.9;
    const filtered = [];
    filtered.push({
        ax: 0, ay: 0, az: 0,
        gx: buffer[0].gx, gy: buffer[0].gy, gz: buffer[0].gz
    });
    for (let i = 1; i < buffer.length; i++) {
        filtered.push({
            ax: alpha * (filtered[i - 1].ax + buffer[i].ax - buffer[i - 1].ax),
            ay: alpha * (filtered[i - 1].ay + buffer[i].ay - buffer[i - 1].ay),
            az: alpha * (filtered[i - 1].az + buffer[i].az - buffer[i - 1].az),
            gx: buffer[i].gx, gy: buffer[i].gy, gz: buffer[i].gz
        });
    }
    return filtered;
}

// =============================================================
// PER-REP FEATURE EXTRACTION
// =============================================================
function extractRepFeatures(filteredBuffer, event) {
    const start = Math.max(0, event.start_sample);
    const end = Math.min(filteredBuffer.length, event.end_sample);
    const samples = filteredBuffer.slice(start, end);
    if (samples.length === 0) return null;

    let peakAccel = 0;
    for (let i = 0; i < samples.length; i++) {
        const s = samples[i];
        const mag = Math.sqrt(s.ax * s.ax + s.ay * s.ay + s.az * s.az) * 9.81;
        if (mag > peakAccel) peakAccel = mag;
    }

    const duration = (end - start) / 50;

    let peakGyro = 0;
    for (let i = 0; i < samples.length; i++) {
        const s = samples[i];
        const mag = Math.sqrt(s.gx * s.gx + s.gy * s.gy + s.gz * s.gz);
        if (mag > peakGyro) peakGyro = mag;
    }

    return { peak_accel: peakAccel, duration, peak_gyro: peakGyro };
}

// =============================================================
// SESSION-LEVEL INDICATORS
// =============================================================
function computeSessionIndicators(repFeatures, heightM) {
    const n = repFeatures.length;
    if (n === 0) return null;

    const repCount = n;
    const meanTime = repFeatures.reduce((s, r) => s + r.duration, 0) / n;
    const power = (0.9 * 9.81 * (heightM * 0.5 - 0.46)) / (meanTime * 0.5);

    const accels = repFeatures.map(r => r.peak_accel);
    const meanAccel = accels.reduce((a, b) => a + b, 0) / n;
    const stdAccel = Math.sqrt(accels.reduce((s, a) => s + (a - meanAccel) ** 2, 0) / n);
    const cvAccel = meanAccel > 0 ? stdAccel / meanAccel : 0;

    let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
    for (let i = 0; i < n; i++) {
        const x = i + 1, y = accels[i];
        sumX += x; sumY += y; sumXY += x * y; sumX2 += x * x;
    }
    const denom = n * sumX2 - sumX * sumX;
    const fatigueSlope = denom !== 0 ? (n * sumXY - sumX * sumY) / denom : 0;

    const flags = {
        weakness_accel: meanAccel < 2.7 ? 'low' : meanAccel > 8.5 ? 'high' : 'intermediate',
        weakness_power: power < 2.0 ? 'below_range' : 'within_range',
        exhaustion_cv: cvAccel < 0.15 ? 'stable' : cvAccel < 0.30 ? 'moderate' : 'high',
        exhaustion_fatigue: fatigueSlope > -0.05 ? 'stable' : fatigueSlope > -0.15 ? 'mild_decline' : 'significant_decline'
    };

    return { repCount, meanTime, power, cvAccel, fatigueSlope, flags, perRep: repFeatures };
}

// =============================================================
// FULL ANALYSIS PIPELINE
// =============================================================
function analyzeSession(buffer) {
    const profile = getProfile();
    const heightM = (profile && profile.height_m) ? profile.height_m : 1.70;

    console.log('\n=== Peak Detection & Quality Assessment ===');

    const peaks = detectPeaks(buffer);
    const events = peaksToEvents(peaks);
    console.log(`Detected ${events.length} rep(s) via peak detection`);
    events.forEach(e => {
        console.log(`  Rep ${e.rep}: peak at sample ${e.peak_sample} (${(e.peak_sample/50).toFixed(2)}s), value=${peaks[e.rep-1].value.toFixed(3)}g`);
    });

    if (events.length === 0) {
        console.log('No reps detected.');
        return null;
    }

    const filteredBuffer = removeGravity(buffer);

    const repFeatures = [];
    events.forEach(event => {
        const feats = extractRepFeatures(filteredBuffer, event);
        if (feats) repFeatures.push(feats);
    });

    const session = computeSessionIndicators(repFeatures, heightM);
    if (session) {
        console.log(`Rep count: ${session.repCount}, Power: ${session.power.toFixed(2)} W/kg`);
    }

    return session;
}

// =============================================================
// STOP TEST
// =============================================================
function stopTest() {
    isRunning = false;

    if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
    if (sensorListener) {
        window.removeEventListener('devicemotion', sensorListener);
        sensorListener = null;
    }
    stopGraphUpdates();

    // End beep
    playBeep(600, 500);

    // Show loading overlay
    document.getElementById('loading-overlay').style.display = 'flex';

    setTimeout(() => {
        try {
            // Resample
            const result = resampleTo50Hz(sensorBuffer);
            sensorBuffer = result.resampled;

            console.log('=== Test Complete ===');
            console.log(`Total samples: ${sensorBuffer.length}`);

            const sessionData = analyzeSession(sensorBuffer);

            lastSessionData = sessionData;
            renderResults(sessionData);
            document.getElementById('loading-overlay').style.display = 'none';
            showScreen(screenResults);
        } catch (err) {
            console.error('Error processing test data:', err);
            document.getElementById('loading-overlay').style.display = 'none';
            lastSessionData = null;
            renderResults(null);
            showScreen(screenResults);
        }
    }, 50);
}

// =============================================================
// SVG MINI CHARTS
// =============================================================
function createBarChart(values, options = {}) {
    const {
        width = 140, height = 60, color = '#30D158',
        showTrend = false, trendSlope = 0, trendIntercept = 0
    } = options;
    if (!values || values.length === 0) return '';

    const maxVal = Math.max(...values, 0.001);
    const barWidth = Math.max(4, Math.min(20, (width - 4) / values.length - 2));
    const gap = 2;
    const totalWidth = values.length * (barWidth + gap) - gap;
    const offsetX = (width - totalWidth) / 2;

    let bars = '';
    values.forEach((v, i) => {
        const barH = Math.max(2, (v / maxVal) * (height - 8));
        const x = offsetX + i * (barWidth + gap);
        const y = height - barH - 2;
        bars += `<rect x="${x}" y="${y}" width="${barWidth}" height="${barH}" rx="2" fill="${color}" opacity="0.7"/>`;
    });

    let trendLine = '';
    if (showTrend && values.length > 1) {
        const y1 = height - 2 - ((trendIntercept + trendSlope) / maxVal) * (height - 8);
        const y2 = height - 2 - ((trendIntercept + trendSlope * values.length) / maxVal) * (height - 8);
        const x1 = offsetX + barWidth / 2;
        const x2 = offsetX + (values.length - 1) * (barWidth + gap) + barWidth / 2;
        trendLine = `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#FF453A" stroke-width="2" stroke-dasharray="4,2"/>`;
    }

    return `<svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">${bars}${trendLine}</svg>`;
}

// =============================================================
// RENDER RESULTS SCREEN
// =============================================================
function renderResults(session, savedDate) {
    const dateObj = savedDate ? new Date(savedDate) : new Date();
    document.getElementById('result-date').textContent =
        dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' }) +
        ' at ' + dateObj.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

    if (!session || session.repCount === 0) {
        document.getElementById('result-reps').textContent = '0';
        document.getElementById('result-norm').innerHTML =
            '<strong>No movements detected</strong><br>' +
            'Make sure your phone is secured at waist level and you stand up fully from the chair.';
        document.getElementById('result-power').textContent = '\u2014';
        document.getElementById('result-power-status').textContent = '';
        ['accel', 'gyro', 'cv', 'fatigue'].forEach(id => {
            document.getElementById('status-' + id).textContent = 'No data';
            document.getElementById('detail-' + id).textContent = '';
            const chart = document.getElementById('chart-' + id);
            if (chart) chart.innerHTML = '';
            document.getElementById('card-' + id).className = 'quality-card';
        });
        return;
    }

    document.getElementById('result-reps').textContent = session.repCount;
    const profileForNorm = getProfile();
    const normRange = getNormativeRange(
        profileForNorm ? profileForNorm.age_group : null,
        profileForNorm ? profileForNorm.sex : null
    );
    if (normRange) {
        const sexLabel = profileForNorm.sex === 'female' ? 'Women' : 'Men';
        document.getElementById('result-norm').textContent =
            `Typical for ${sexLabel} ages ${profileForNorm.age_group}: ${normRange[0]}\u2013${normRange[1]} reps`;
    } else {
        document.getElementById('result-norm').textContent =
            'Add age and sex in Settings for a personalized comparison';
    }

    const powerEl = document.getElementById('result-power');
    const powerStatusEl = document.getElementById('result-power-status');
    powerEl.textContent = session.power.toFixed(2) + ' W/kg';

    if (session.flags.weakness_power === 'below_range') {
        powerEl.className = 'power-value text-yellow';
        powerStatusEl.textContent = 'Below typical range';
        powerStatusEl.className = 'power-status text-yellow';
    } else {
        powerEl.className = 'power-value text-green';
        powerStatusEl.textContent = 'Within typical range';
        powerStatusEl.className = 'power-status text-green';
    }

    const perRep = session.perRep;
    const accels = perRep.map(r => r.peak_accel);
    const meanAccel = accels.reduce((a, b) => a + b, 0) / accels.length;
    document.getElementById('chart-accel').innerHTML = createBarChart(accels, { color: statusColor(session.flags.weakness_accel) });
    document.getElementById('card-accel').className = 'quality-card status-' + statusClass(session.flags.weakness_accel);
    const accelStatusText = session.flags.weakness_accel === 'low' ? 'Low' :
        session.flags.weakness_accel === 'high' ? 'Strong' : 'Moderate';
    document.getElementById('status-accel').textContent = accelStatusText;
    document.getElementById('status-accel').className = 'card-status ' + statusTextClass(session.flags.weakness_accel);
    document.getElementById('detail-accel').innerHTML =
        `Avg ${meanAccel.toFixed(1)} m/s\u00B2 across ${accels.length} rep${accels.length !== 1 ? 's' : ''}<br><span style="color:rgba(255,255,255,0.3);font-size:12px;">How forcefully you push up</span>`;

    const gyros = perRep.map(r => r.peak_gyro);
    const meanGyro = gyros.reduce((a, b) => a + b, 0) / gyros.length;
    const gyroStatus = meanGyro > 2.0 ? 'high' : meanGyro > 1.0 ? 'intermediate' : 'low';
    document.getElementById('chart-gyro').innerHTML = createBarChart(gyros, { color: statusColor(gyroStatus) });
    document.getElementById('card-gyro').className = 'quality-card status-' + statusClass(gyroStatus);
    const gyroStatusText = gyroStatus === 'low' ? 'Low' : gyroStatus === 'high' ? 'Good' : 'Moderate';
    document.getElementById('status-gyro').textContent = gyroStatusText;
    document.getElementById('status-gyro').className = 'card-status ' + statusTextClass(gyroStatus);
    document.getElementById('detail-gyro').innerHTML =
        `Avg ${meanGyro.toFixed(2)} rad/s across ${gyros.length} rep${gyros.length !== 1 ? 's' : ''}<br><span style="color:rgba(255,255,255,0.3);font-size:12px;">How quickly you transition</span>`;

    const cvCard = document.getElementById('card-cv');
    const cvFlag = session.flags.exhaustion_cv;
    cvCard.className = 'quality-card status-' + statusClass(cvFlag === 'stable' ? 'high' : cvFlag === 'moderate' ? 'intermediate' : 'low');
    document.getElementById('status-cv').textContent = `CV = ${session.cvAccel.toFixed(2)}`;
    document.getElementById('status-cv').className = 'card-status ' +
        (cvFlag === 'stable' ? 'text-green' : cvFlag === 'moderate' ? 'text-yellow' : 'text-red');
    const cvDetailText = cvFlag === 'stable' ? 'Consistent reps throughout' :
        cvFlag === 'moderate' ? 'Some variation between reps' : 'Significant variation between reps';
    document.getElementById('detail-cv').innerHTML =
        cvDetailText + '<br><span style="color:rgba(255,255,255,0.3);font-size:12px;">Rep-to-rep similarity</span>';

    const fatigueCard = document.getElementById('card-fatigue');
    const fatFlag = session.flags.exhaustion_fatigue;
    fatigueCard.className = 'quality-card status-' + statusClass(fatFlag === 'stable' ? 'high' : fatFlag === 'mild_decline' ? 'intermediate' : 'low');
    const meanRepNum = (accels.length + 1) / 2;
    const trendIntercept = meanAccel - session.fatigueSlope * meanRepNum;
    document.getElementById('chart-fatigue').innerHTML = createBarChart(accels, {
        color: '#8E8E93',
        showTrend: accels.length > 1,
        trendSlope: session.fatigueSlope,
        trendIntercept: trendIntercept
    });
    const fatStatusText = fatFlag === 'stable' ? 'Stable' :
        fatFlag === 'mild_decline' ? 'Mild decline' : 'Significant decline';
    document.getElementById('status-fatigue').textContent = fatStatusText;
    document.getElementById('status-fatigue').className = 'card-status ' +
        (fatFlag === 'stable' ? 'text-green' : fatFlag === 'mild_decline' ? 'text-yellow' : 'text-red');
    const fatDetailText = fatFlag === 'stable' ? 'Steady performance throughout' :
        fatFlag === 'mild_decline' ? 'Later reps slightly weaker' :
        'Notable drop-off in later reps';
    document.getElementById('detail-fatigue').innerHTML =
        fatDetailText + '<br><span style="color:rgba(255,255,255,0.3);font-size:12px;">Early vs. late performance</span>';
}

function statusColor(flag) {
    if (flag === 'high' || flag === 'strong') return '#30D158';
    if (flag === 'intermediate' || flag === 'moderate') return '#FF9F0A';
    return '#FF453A';
}
function statusClass(flag) {
    if (flag === 'high' || flag === 'strong') return 'green';
    if (flag === 'intermediate' || flag === 'moderate') return 'yellow';
    return 'red';
}
function statusTextClass(flag) {
    if (flag === 'high' || flag === 'strong') return 'text-green';
    if (flag === 'intermediate' || flag === 'moderate') return 'text-yellow';
    return 'text-red';
}

// =============================================================
// SETUP SCREEN LOGIC
// =============================================================
function initSetup() {
    const unitToggle = document.getElementById('unit-toggle');
    const cmInput = document.getElementById('height-cm-input');
    const ftinInput = document.getElementById('height-ftin-input');

    unitToggle.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        unitToggle.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if (btn.dataset.unit === 'cm') {
            cmInput.style.display = '';
            ftinInput.style.display = 'none';
        } else {
            cmInput.style.display = 'none';
            ftinInput.style.display = '';
        }
    });

    btnGetStarted.addEventListener('click', () => {
        let heightM = 0;
        const activeUnit = unitToggle.querySelector('button.active').dataset.unit;

        if (activeUnit === 'cm') {
            const cm = parseFloat(document.getElementById('setup-height-cm').value);
            if (!cm || cm < 100 || cm > 250) {
                alert('Please enter a valid height (100-250 cm).');
                return;
            }
            heightM = cm / 100;
        } else {
            const ft = parseInt(document.getElementById('setup-height-ft').value) || 0;
            const inches = parseInt(document.getElementById('setup-height-in').value) || 0;
            const totalInches = ft * 12 + inches;
            if (totalInches < 36 || totalInches > 96) {
                alert('Please enter a valid height (3-8 feet).');
                return;
            }
            heightM = totalInches * 0.0254;
        }

        const profile = {
            height_m: parseFloat(heightM.toFixed(2)),
            age_group: document.getElementById('setup-age').value || null,
            sex: document.getElementById('setup-sex').value || null,
            setup_date: new Date().toISOString().slice(0, 10)
        };

        saveProfile(profile);
        showScreen(screenPretest);
    });
}

// =============================================================
// DASHBOARD
// =============================================================
let currentMetric = 'rep_count';

function showDashboard() {
    renderDashboard();
    showScreen(screenDashboard);
}

function renderDashboard() {
    const sessions = getSessions();
    renderTrendChart(sessions);
    renderTrendAlerts(sessions);
    renderSessionList(sessions);
}

function getMetricValue(session, metric) {
    switch (metric) {
        case 'rep_count': return session.rep_count;
        case 'power_wkg': return session.power_wkg;
        case 'mean_peak_accel':
            return session.per_rep.length > 0 ?
                session.per_rep.reduce((s, r) => s + r.peak_accel, 0) / session.per_rep.length : 0;
        case 'cv_accel': return session.cv_accel;
        case 'fatigue_slope': return session.fatigue_slope;
        default: return 0;
    }
}

function getMetricLabel(metric) {
    switch (metric) {
        case 'rep_count': return 'Reps';
        case 'power_wkg': return 'W/kg';
        case 'mean_peak_accel': return 'm/s\u00B2';
        case 'cv_accel': return 'CV';
        case 'fatigue_slope': return 'slope';
        default: return '';
    }
}

function getThresholdForMetric(metric) {
    switch (metric) {
        case 'power_wkg': return { value: 2.0, label: '2.0 W/kg', color: '#FF9F0A' };
        case 'mean_peak_accel': return { value: 2.7, label: '2.7 m/s\u00B2', color: '#FF9F0A' };
        case 'cv_accel': return { value: 0.30, label: 'CV 0.30', color: '#FF9F0A' };
        case 'fatigue_slope': return { value: -0.15, label: '-0.15', color: '#FF9F0A' };
        default: return null;
    }
}

function renderTrendChart(sessions) {
    const container = document.getElementById('trend-chart-container');
    if (sessions.length === 0) {
        container.innerHTML = '<div class="chart-msg">Complete your first test to start tracking trends.</div>';
        return;
    }

    const sorted = [...sessions].sort((a, b) => new Date(a.date) - new Date(b.date));
    const values = sorted.map(s => getMetricValue(s, currentMetric));
    const labels = sorted.map(s => {
        const d = new Date(s.date);
        return (d.getMonth() + 1) + '/' + d.getDate();
    });

    const W = 360, H = 160, pad = 40;
    const plotW = W - pad * 2, plotH = H - pad * 2;

    let minVal = Math.min(...values);
    let maxVal = Math.max(...values);
    if (minVal === maxVal) { minVal -= 1; maxVal += 1; }
    const range = maxVal - minVal;

    const xStep = values.length > 1 ? plotW / (values.length - 1) : plotW / 2;
    let points = values.map((v, i) => {
        const x = pad + (values.length > 1 ? i * xStep : plotW / 2);
        const y = pad + plotH - ((v - minVal) / range) * plotH;
        return { x, y };
    });

    let svgContent = `<line x1="${pad}" y1="${pad}" x2="${pad}" y2="${pad + plotH}" stroke="#3A3A3C" stroke-width="1"/>`;
    svgContent += `<line x1="${pad}" y1="${pad + plotH}" x2="${pad + plotW}" y2="${pad + plotH}" stroke="#3A3A3C" stroke-width="1"/>`;

    const threshold = getThresholdForMetric(currentMetric);
    if (threshold && threshold.value >= minVal && threshold.value <= maxVal) {
        const thY = pad + plotH - ((threshold.value - minVal) / range) * plotH;
        svgContent += `<line x1="${pad}" y1="${thY}" x2="${pad + plotW}" y2="${thY}" stroke="${threshold.color}" stroke-width="1" stroke-dasharray="4,3"/>`;
        svgContent += `<text x="${pad + plotW + 2}" y="${thY + 4}" font-size="10" fill="${threshold.color}">${threshold.label}</text>`;
    }

    if (points.length > 1) {
        const pathD = points.map((p, i) => (i === 0 ? `M${p.x},${p.y}` : `L${p.x},${p.y}`)).join(' ');
        svgContent += `<path d="${pathD}" fill="none" stroke="#30D158" stroke-width="2"/>`;
    }

    points.forEach((p, i) => {
        svgContent += `<circle cx="${p.x}" cy="${p.y}" r="4" fill="#30D158"/>`;
        svgContent += `<text x="${p.x}" y="${p.y - 8}" text-anchor="middle" font-size="11" fill="#FFFFFF">${typeof values[i] === 'number' ? (Number.isInteger(values[i]) ? values[i] : values[i].toFixed(2)) : values[i]}</text>`;
        svgContent += `<text x="${p.x}" y="${pad + plotH + 14}" text-anchor="middle" font-size="10" fill="rgba(255,255,255,0.4)">${labels[i]}</text>`;
    });

    svgContent += `<text x="${pad - 4}" y="${pad - 4}" text-anchor="end" font-size="10" fill="rgba(255,255,255,0.4)">${typeof maxVal === 'number' ? (Number.isInteger(maxVal) ? maxVal : maxVal.toFixed(2)) : maxVal}</text>`;
    svgContent += `<text x="${pad - 4}" y="${pad + plotH + 4}" text-anchor="end" font-size="10" fill="rgba(255,255,255,0.4)">${typeof minVal === 'number' ? (Number.isInteger(minVal) ? minVal : minVal.toFixed(2)) : minVal}</text>`;

    const label = getMetricLabel(currentMetric);
    svgContent += `<text x="${W / 2}" y="${H - 2}" text-anchor="middle" font-size="11" fill="rgba(255,255,255,0.55)">${label}</text>`;

    container.innerHTML = `<svg width="100%" viewBox="0 0 ${W} ${H}">${svgContent}</svg>`;
}

function renderTrendAlerts(sessions) {
    const container = document.getElementById('trend-alerts');
    container.innerHTML = '';
    if (sessions.length < 3) return;

    const sorted = [...sessions].sort((a, b) => new Date(a.date) - new Date(b.date));
    const last3 = sorted.slice(-3);
    const alerts = [];

    const fs = last3.map(s => s.fatigue_slope);
    if (fs[0] < fs[1] && fs[1] < fs[2]) alerts.push('Fatigue slope has increased over your last 3 sessions.');

    const cv = last3.map(s => s.cv_accel);
    if (cv[0] > cv[1] && cv[1] > cv[2]) alerts.push('Consistency has decreased — reps are becoming more variable.');

    const pw = last3.map(s => s.power_wkg);
    if (pw[0] < pw[1] && pw[1] < pw[2]) alerts.push('Power output has decreased over your last 3 sessions.');

    const rc = last3.map(s => s.rep_count);
    if (rc[0] < rc[1] && rc[1] < rc[2]) alerts.push('Rep count has declined over your last 3 sessions.');

    alerts.forEach(msg => {
        container.innerHTML += `<div class="trend-alert">${msg}</div>`;
    });
}

function renderSessionList(sessions) {
    const listContainer = document.getElementById('session-list-items');
    if (sessions.length === 0) {
        listContainer.innerHTML = '<div class="empty-dashboard">Complete your first test to start building your history.</div>';
        return;
    }

    const sorted = [...sessions].sort((a, b) => new Date(b.date) - new Date(a.date));
    listContainer.innerHTML = sorted.map(s => {
        const d = new Date(s.date);
        const dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        const timeStr = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        const flagCount = Object.values(s.flags).filter(f =>
            f === 'low' || f === 'below_range' || f === 'high' || f === 'significant_decline'
        ).length;
        const flagText = flagCount > 0 ? `${flagCount} flag${flagCount > 1 ? 's' : ''}` : '';

        return `<div class="session-item" data-session-id="${s.id}">
                <div class="session-info" onclick="viewSession('${s.id}')">
                    <div class="session-date">${dateStr} at ${timeStr}</div>
                    <div class="session-stats">${s.rep_count} reps \u00B7 ${s.power_wkg.toFixed(1)} W/kg</div>
                    ${flagText ? `<div class="session-flags">${flagText}</div>` : ''}
                </div>
                <button class="session-delete" onclick="event.stopPropagation(); confirmDeleteSession('${s.id}')">Delete</button>
            </div>`;
    }).join('');
}

function viewSession(sessionId) {
    const sessions = getSessions();
    const session = sessions.find(s => s.id === sessionId);
    if (!session) return;

    const displaySession = {
        repCount: session.rep_count,
        meanTime: session.mean_time_per_rep,
        power: session.power_wkg,
        cvAccel: session.cv_accel,
        fatigueSlope: session.fatigue_slope,
        flags: session.flags,
        perRep: session.per_rep.map(r => ({
            peak_accel: r.peak_accel,
            peak_gyro: r.peak_gyro,
            duration: r.duration
        }))
    };

    btnResultsBack.style.display = 'flex';
    btnSave.style.display = 'none';
    btnNewTest.textContent = 'New Test';

    renderResults(displaySession, session.date);
    showScreen(screenResults);
}

function confirmDeleteSession(sessionId) {
    if (confirm('Delete this session? This cannot be undone.')) {
        deleteSession(sessionId);
        renderDashboard();
    }
}

// Metric tab switching
document.getElementById('metric-tabs').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn || !btn.dataset.metric) return;
    document.querySelectorAll('#metric-tabs button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentMetric = btn.dataset.metric;
    renderTrendChart(getSessions());
});

// =============================================================
// EVENT LISTENERS
// =============================================================
btnStart.addEventListener('click', () => {
    if (typeof DeviceMotionEvent === 'undefined') {
        alert('Motion sensors are not available on this device.');
        return;
    }
    // Play start beep immediately in user gesture (required for iOS)
    ensureAudioContext();
    playBeep(800, 300);
    startRealSensors();
});

btnNewTest.addEventListener('click', () => {
    btnResultsBack.style.display = 'none';
    btnSave.style.display = '';
    showScreen(screenPretest);
    timerDisplay.textContent = '30';
});

btnSave.addEventListener('click', () => {
    if (!lastSessionData) return;
    saveSessionToStorage(lastSessionData);
    lastSessionData = null;
    timerDisplay.textContent = '30';
    showDashboard();
});

btnDashboard.addEventListener('click', () => {
    showDashboard();
});

btnSettings.addEventListener('click', () => {
    const profile = getProfile();
    if (profile) {
        document.getElementById('setup-height-cm').value = Math.round(profile.height_m * 100);
        if (profile.age_group) document.getElementById('setup-age').value = profile.age_group;
        if (profile.sex) document.getElementById('setup-sex').value = profile.sex;
    }
    showScreen(screenSetup);
});

btnDashBack.addEventListener('click', () => {
    showScreen(screenPretest);
});

btnResultsBack.addEventListener('click', () => {
    btnResultsBack.style.display = 'none';
    btnSave.style.display = '';
    showDashboard();
});

// =============================================================
// APP INITIALIZATION
// =============================================================
function initApp() {
    initSetup();
    const profile = getProfile();
    if (!profile) {
        showScreen(screenSetup);
    } else {
        showScreen(screenPretest);
    }
}

initApp();

</script>

</body>
</html>
